name: Build and Deploy Documentation

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  docs:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y pandoc

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install sphinx==7.1.2
        pip install sphinx-rtd-theme==1.3.0
        pip install myst-parser==2.0.0
        pip install nbsphinx==0.9.1
        pip install sphinx-copybutton==0.5.2
        pip install sphinx-gallery==0.14.0
        pip install numpy scipy matplotlib tqdm palettable
        # Install package in development mode with minimal dependencies
        pip install --no-deps -e .

    - name: Create _static directory
      run: |
        mkdir -p docs/source/_static

    - name: Build documentation
      run: |
        cd docs
        # Generate API documentation
        sphinx-apidoc -f -o source/api ../PyHydroGeophysX
        # Build HTML documentation with warnings as errors disabled for gallery
        sphinx-build -b html source build/html -W --keep-going
      env:
        # Set environment variable to disable gallery execution
        SPHINX_GALLERY_PLOT: "False"

    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs/build/html
        force_orphan: true
<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PyHydroGeophysX.petrophysics.velocity_models &mdash; PyHydroGeophysX Documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery-rendered-html.css" type="text/css" />
    <link rel="canonical" href="https://YOUR_GITHUB_USERNAME.github.io/PyHydroGeophysX/_modules/PyHydroGeophysX/petrophysics/velocity_models.html" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=2389946f"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
        <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../../../_static/copybutton.js?v=f281be69"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            PyHydroGeophysX
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quick Start</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../api/index.html">API Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html">Examples Gallery</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PyHydroGeophysX</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">PyHydroGeophysX.petrophysics.velocity_models</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for PyHydroGeophysX.petrophysics.velocity_models</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Seismic velocity models for relating rock properties to elastic wave velocities.</span>

<span class="sd">This module provides implementations of several common rock physics models</span>
<span class="sd">to estimate seismic velocities (P-wave and S-wave) based on properties</span>
<span class="sd">such as mineral composition, porosity, saturation, and effective pressure.</span>

<span class="sd">Models included:</span>
<span class="sd">- Voigt-Reuss-Hill (VRH) average for effective medium properties.</span>
<span class="sd">- Brie&#39;s model for effective fluid modulus in partially saturated rocks.</span>
<span class="sd">- Differential Effective Medium (DEM) model for porous rocks.</span>
<span class="sd">- Hertz-Mindlin contact theory combined with Hashin-Shtrikman bounds.</span>

<span class="sd">The module also includes standalone functions that appear to be earlier or alternative</span>
<span class="sd">implementations of some of these models (VRH_model, satK, velDEM, vel_porous).</span>
<span class="sd">These might be for specific use cases or represent developmental versions.</span>
<span class="sd">It&#39;s important to distinguish these from the class-based models for clarity.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">fsolve</span><span class="p">,</span> <span class="n">root</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span> <span class="c1"># Dict not used, Optional not used in current signatures</span>

<span class="c1"># Define a type alias for inputs that can be scalar or array-like for clarity</span>
<span class="n">ScalarOrArray</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>


<div class="viewcode-block" id="BaseVelocityModel"><a class="viewcode-back" href="../../../api/petrophysics.html#PyHydroGeophysX.BaseVelocityModel">[docs]</a><span class="k">class</span> <span class="nc">BaseVelocityModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for seismic velocity models.</span>

<span class="sd">    This class provides a common interface for different velocity models.</span>
<span class="sd">    Subclasses should implement the `calculate_velocity` method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="BaseVelocityModel.__init__"><a class="viewcode-back" href="../../../api/petrophysics.html#PyHydroGeophysX.BaseVelocityModel.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize base velocity model.&quot;&quot;&quot;</span>
        <span class="c1"># No specific initialization needed for the base class itself.</span>
        <span class="k">pass</span></div>
    
<div class="viewcode-block" id="BaseVelocityModel.calculate_velocity"><a class="viewcode-back" href="../../../api/petrophysics.html#PyHydroGeophysX.BaseVelocityModel.calculate_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abstract method to calculate seismic velocity from rock properties.</span>

<span class="sd">        This method must be implemented by derived classes. Each implementation</span>
<span class="sd">        will take specific rock and fluid properties relevant to that model.</span>

<span class="sd">        Args:</span>
<span class="sd">            **kwargs: Model-specific keyword arguments representing rock and fluid properties</span>
<span class="sd">                      (e.g., porosity, saturation, bulk_moduli, shear_moduli, densities).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Union[np.ndarray, Tuple[np.ndarray, np.ndarray]]:</span>
<span class="sd">                Depending on the model, this could be a single array (e.g., P-wave velocity)</span>
<span class="sd">                or a tuple of arrays (e.g., P-wave and S-wave velocities).</span>

<span class="sd">        Raises:</span>
<span class="sd">            NotImplementedError: If the method is not implemented in a derived class.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;The &#39;calculate_velocity&#39; method must be implemented in derived classes.&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="VRHModel"><a class="viewcode-back" href="../../../api/petrophysics.html#PyHydroGeophysX.VRHModel">[docs]</a><span class="k">class</span> <span class="nc">VRHModel</span><span class="p">(</span><span class="n">BaseVelocityModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Voigt-Reuss-Hill (VRH) mixing model for effective elastic properties of composites.</span>

<span class="sd">    The VRH model calculates the arithmetic average of the Voigt upper bound</span>
<span class="sd">    (iso-strain condition) and the Reuss lower bound (iso-stress condition)</span>
<span class="sd">    for the effective bulk and shear moduli of a mineral mixture.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="VRHModel.__init__"><a class="viewcode-back" href="../../../api/petrophysics.html#PyHydroGeophysX.VRHModel.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize VRH model.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></div>
        <span class="c1"># No specific parameters for VRH model itself beyond inputs to methods.</span>
    
<div class="viewcode-block" id="VRHModel.calculate_properties"><a class="viewcode-back" href="../../../api/petrophysics.html#PyHydroGeophysX.VRHModel.calculate_properties">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_properties</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                           <span class="n">fractions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                           <span class="n">bulk_moduli</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="c1"># K for each component</span>
                           <span class="n">shear_moduli</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span><span class="c1"># G for each component</span>
                           <span class="n">densities</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>   <span class="c1"># ρ for each component</span>
                           <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate effective elastic properties (bulk modulus, shear modulus, density)</span>
<span class="sd">        of a mineral mixture using the Voigt-Reuss-Hill (VRH) averaging scheme.</span>

<span class="sd">        Args:</span>
<span class="sd">            fractions (List[float]): List of volume fractions for each mineral component.</span>
<span class="sd">                                     Must sum to 1.0.</span>
<span class="sd">            bulk_moduli (List[float]): List of bulk moduli (K) for each mineral component [GPa].</span>
<span class="sd">            shear_moduli (List[float]): List of shear moduli (G) for each mineral component [GPa].</span>
<span class="sd">            densities (List[float]): List of densities (ρ) for each mineral component [kg/m³].</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[float, float, float]: A tuple containing:</span>
<span class="sd">                - K_vrh (float): Effective bulk modulus of the mixture [GPa].</span>
<span class="sd">                - G_vrh (float): Effective shear modulus of the mixture [GPa].</span>
<span class="sd">                - rho_eff (float): Effective density of the mixture [kg/m³].</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If `fractions` do not sum to 1.0 (within tolerance) or if</span>
<span class="sd">                        input lists (fractions, K, G, rho) have different lengths or are empty.</span>
<span class="sd">            ZeroDivisionError: If any component bulk or shear modulus is zero when calculating Reuss average</span>
<span class="sd">                               (as it involves division by K_i or G_i).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fractions</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">bulk_moduli</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">shear_moduli</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">densities</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input lists (fractions, bulk_moduli, shear_moduli, densities) must have the same length.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fractions</span><span class="p">:</span> <span class="c1"># Check for empty list</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input lists cannot be empty.&quot;</span><span class="p">)</span>

        <span class="c1"># Convert inputs to NumPy arrays for vectorized calculations</span>
        <span class="n">f_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fractions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">K_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bulk_moduli</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">G_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shear_moduli</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">rho_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">densities</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        
        <span class="c1"># Verify that fractions sum to approximately 1.0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f_arr</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Volume fractions must sum to 1.0. Current sum: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f_arr</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># Potential Issue: Division by zero if any K_i or G_i is zero for Reuss average.</span>
        <span class="c1"># Check for zeros in moduli where they are used as divisors.</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">K_arr</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span> <span class="c1"># Bulk modulus should be positive</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Component bulk moduli must be positive for Reuss average calculation.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">G_arr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span> <span class="c1"># Shear modulus should be non-negative (can be 0 for fluids)</span>
             <span class="c1"># If G_arr contains 0, 1.0 / G_arr will be inf. np.sum(f_arr / G_arr) could be inf.</span>
             <span class="c1"># 1.0 / inf is 0. So G_reuss can be 0 if a component has G=0 (fluid). This is valid.</span>
             <span class="c1"># However, if ALL components are fluid (all G_i=0), G_reuss would be 0/0 -&gt; NaN.</span>
             <span class="c1"># For a mixture of fluids, G_reuss should be 0.</span>
             <span class="k">pass</span> <span class="c1"># Allow G=0 for fluids.</span>

        <span class="c1"># Calculate Voigt average (upper bound): K_V = Σ(f_i * K_i), G_V = Σ(f_i * G_i)</span>
        <span class="n">K_voigt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f_arr</span> <span class="o">*</span> <span class="n">K_arr</span><span class="p">)</span>
        <span class="n">G_voigt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f_arr</span> <span class="o">*</span> <span class="n">G_arr</span><span class="p">)</span>
        
        <span class="c1"># Calculate Reuss average (lower bound): 1/K_R = Σ(f_i / K_i), 1/G_R = Σ(f_i / G_i)</span>
        <span class="c1"># Avoid division by zero for G_reuss if all G_arr are zero (e.g., mixture of fluids)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">G_arr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">G_reuss</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Temporarily set G_arr to infinity where G_arr is zero to make f_arr/G_arr zero for those components</span>
            <span class="c1"># This correctly handles fluid components (G=0) in the Reuss sum for shear modulus.</span>
            <span class="c1"># An alternative: sum only non-fluid components, then adjust.</span>
            <span class="c1"># Or, if a component has G_i = 0, its contribution f_i/G_i to the sum is effectively infinite,</span>
            <span class="c1"># making 1/G_reuss infinite, so G_reuss = 0. This is physically correct for mixtures with fluids.</span>
            <span class="c1"># np.sum(f_arr / G_arr) will correctly yield `inf` if any G_i is 0 and f_i &gt; 0.</span>
            <span class="c1"># Then 1.0 / `inf` is 0.0. This handles fluids correctly.</span>
            <span class="c1"># Ensure no f_i/0 where f_i is also 0, but f_arr elements should be &gt;0 for components.</span>
            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span> <span class="c1"># Suppress warning for division by zero if G_i = 0</span>
                <span class="n">K_reuss</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f_arr</span> <span class="o">/</span> <span class="n">K_arr</span><span class="p">)</span>
                <span class="n">sum_f_over_G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f_arr</span> <span class="o">/</span> <span class="n">G_arr</span><span class="p">)</span> <span class="c1"># This can be inf if any G_i is 0</span>
            
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">sum_f_over_G</span><span class="p">):</span> <span class="c1"># If any component is fluid (G_i=0, f_i&gt;0)</span>
                <span class="n">G_reuss</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">elif</span> <span class="n">sum_f_over_G</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Only if all f_i are zero (already checked by sum(f)=1) or all G_i are inf</span>
                <span class="n">G_reuss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="c1"># Or handle as error, implies no shear rigidity (like vacuum) or infinitely stiff</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">G_reuss</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">sum_f_over_G</span>

        <span class="c1"># Calculate Hill (VRH) arithmetic average of Voigt and Reuss bounds</span>
        <span class="n">K_vrh</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">K_voigt</span> <span class="o">+</span> <span class="n">K_reuss</span><span class="p">)</span>
        <span class="n">G_vrh</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">G_voigt</span> <span class="o">+</span> <span class="n">G_reuss</span><span class="p">)</span>
        
        <span class="c1"># Calculate effective density (simple arithmetic weighted average)</span>
        <span class="n">rho_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f_arr</span> <span class="o">*</span> <span class="n">rho_arr</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">K_vrh</span><span class="p">,</span> <span class="n">G_vrh</span><span class="p">,</span> <span class="n">rho_eff</span></div>
    
<div class="viewcode-block" id="VRHModel.calculate_velocity"><a class="viewcode-back" href="../../../api/petrophysics.html#PyHydroGeophysX.VRHModel.calculate_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                         <span class="n">fractions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                         <span class="n">bulk_moduli</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                         <span class="n">shear_moduli</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                         <span class="n">densities</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate P-wave (Vp) and S-wave (Vs) velocities for a mineral mixture</span>
<span class="sd">        using the VRH model for effective elastic moduli and density.</span>

<span class="sd">        Args:</span>
<span class="sd">            fractions (List[float]): Volume fractions of each mineral component. Must sum to 1.0.</span>
<span class="sd">            bulk_moduli (List[float]): Bulk moduli (K) of each mineral [GPa].</span>
<span class="sd">            shear_moduli (List[float]): Shear moduli (G) of each mineral [GPa].</span>
<span class="sd">            densities (List[float]): Densities (ρ) of each mineral [kg/m³].</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[float, float]: A tuple containing:</span>
<span class="sd">                - Vp (float): P-wave velocity [m/s].</span>
<span class="sd">                - Vs (float): S-wave velocity [m/s].</span>
<span class="sd">        </span>
<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If calculated effective properties (K_eff, G_eff, rho_eff) are non-physical</span>
<span class="sd">                        (e.g., negative density, negative moduli leading to NaN in sqrt).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate effective elastic properties (K_eff, G_eff, rho_eff) in GPa and kg/m³</span>
        <span class="n">K_eff_gpa</span><span class="p">,</span> <span class="n">G_eff_gpa</span><span class="p">,</span> <span class="n">rho_eff_kg_m3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_properties</span><span class="p">(</span>
            <span class="n">fractions</span><span class="p">,</span> <span class="n">bulk_moduli</span><span class="p">,</span> <span class="n">shear_moduli</span><span class="p">,</span> <span class="n">densities</span>
        <span class="p">)</span>
        
        <span class="c1"># Validate effective properties before velocity calculation</span>
        <span class="k">if</span> <span class="n">rho_eff_kg_m3</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effective density must be positive. Calculated: </span><span class="si">{</span><span class="n">rho_eff_kg_m3</span><span class="si">}</span><span class="s2"> kg/m³&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">K_eff_gpa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Effective bulk modulus should be non-negative</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effective bulk modulus must be non-negative. Calculated: </span><span class="si">{</span><span class="n">K_eff_gpa</span><span class="si">}</span><span class="s2"> GPa&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">G_eff_gpa</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Effective shear modulus should be non-negative</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effective shear modulus must be non-negative. Calculated: </span><span class="si">{</span><span class="n">G_eff_gpa</span><span class="si">}</span><span class="s2"> GPa&quot;</span><span class="p">)</span>

        <span class="c1"># Convert moduli from GPa to Pascals (Pa) for velocity calculation (1 GPa = 1e9 Pa)</span>
        <span class="n">K_eff_pa</span> <span class="o">=</span> <span class="n">K_eff_gpa</span> <span class="o">*</span> <span class="mf">1e9</span>
        <span class="n">G_eff_pa</span> <span class="o">=</span> <span class="n">G_eff_gpa</span> <span class="o">*</span> <span class="mf">1e9</span>
        
        <span class="c1"># Calculate P-wave velocity (Vp = sqrt((K + 4/3*G) / ρ))</span>
        <span class="c1"># The term (K_eff_pa + (4/3) * G_eff_pa) is the P-wave modulus (M).</span>
        <span class="c1"># M must be non-negative.</span>
        <span class="n">p_wave_modulus</span> <span class="o">=</span> <span class="n">K_eff_pa</span> <span class="o">+</span> <span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">G_eff_pa</span>
        <span class="k">if</span> <span class="n">p_wave_modulus</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;P-wave modulus (K + 4/3*G) is negative (</span><span class="si">{</span><span class="n">p_wave_modulus</span><span class="si">}</span><span class="s2"> Pa), leading to invalid Vp.&quot;</span><span class="p">)</span>
        
        <span class="n">Vp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_wave_modulus</span> <span class="o">/</span> <span class="n">rho_eff_kg_m3</span><span class="p">)</span>
        
        <span class="c1"># Calculate S-wave velocity (Vs = sqrt(G / ρ))</span>
        <span class="c1"># G_eff_pa must be non-negative. rho_eff_kg_m3 must be positive.</span>
        <span class="k">if</span> <span class="n">G_eff_pa</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># If effective shear modulus is zero (e.g. fluid mixture)</span>
            <span class="n">Vs</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># G_eff_pa &gt; 0</span>
            <span class="n">Vs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">G_eff_pa</span> <span class="o">/</span> <span class="n">rho_eff_kg_m3</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">Vp</span><span class="p">,</span> <span class="n">Vs</span></div></div>


<div class="viewcode-block" id="BrieModel"><a class="viewcode-back" href="../../../api/petrophysics.html#PyHydroGeophysX.BrieModel">[docs]</a><span class="k">class</span> <span class="nc">BrieModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Brie&#39;s empirical model for calculating the effective bulk modulus of a fluid mixture</span>
<span class="sd">    (typically water and gas) in a partially saturated porous medium.</span>

<span class="sd">    The model uses an exponent to describe how fluid phases mix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="BrieModel.__init__"><a class="viewcode-back" href="../../../api/petrophysics.html#PyHydroGeophysX.BrieModel.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exponent</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize Brie&#39;s model.</span>

<span class="sd">        Args:</span>
<span class="sd">            exponent (float, optional): Brie&#39;s mixing exponent. Common values range</span>
<span class="sd">                                        from 1 (iso-stress, Reuss-like for fluid) to</span>
<span class="sd">                                        very large (iso-strain, Voigt-like for fluid).</span>
<span class="sd">                                        A typical default is 3.0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exponent</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Brie&#39;s exponent must be a numeric value.&quot;</span><span class="p">)</span>
        <span class="c1"># Potential Issue: Exponent value constraints? (e.g., positive).</span>
        <span class="c1"># Original paper might specify typical ranges or constraints. For now, accept any float.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exponent</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">exponent</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="BrieModel.calculate_fluid_modulus"><a class="viewcode-back" href="../../../api/petrophysics.html#PyHydroGeophysX.BrieModel.calculate_fluid_modulus">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_fluid_modulus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                              <span class="n">saturation_water</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="c1"># Renamed for clarity</span>
                              <span class="n">water_bulk_modulus</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.2</span><span class="p">,</span> <span class="c1"># Corrected default for water (approx 2.2 GPa)</span>
                              <span class="n">gas_bulk_modulus</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="c1"># Bulk modulus of gas (e.g. air at STP)</span>
                              <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the effective bulk modulus of a fluid mixture (water and gas)</span>
<span class="sd">        using Brie&#39;s empirical equation:</span>
<span class="sd">            K_fluid_eff = (K_water - K_gas) * S_water^e + K_gas</span>
<span class="sd">        where &#39;e&#39; is Brie&#39;s exponent.</span>

<span class="sd">        Args:</span>
<span class="sd">            saturation_water (float): Water saturation (S_w), ranging from 0.0 (fully gas)</span>
<span class="sd">                                      to 1.0 (fully water).</span>
<span class="sd">            water_bulk_modulus (float, optional): Bulk modulus of water (K_w) [GPa].</span>
<span class="sd">                                                  Defaults to 2.2 GPa.</span>
<span class="sd">            gas_bulk_modulus (float, optional): Bulk modulus of gas (K_gas) [GPa].</span>
<span class="sd">                                                Defaults to 0.01 GPa (approx. for air at STP).</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            float: Effective bulk modulus of the fluid mixture (K_fluid_eff) [GPa].</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If saturation is not between 0 and 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">saturation_water</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Water saturation must be between 0 and 1.&quot;</span><span class="p">)</span>
        <span class="c1"># Ensure moduli are positive</span>
        <span class="k">if</span> <span class="n">water_bulk_modulus</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">gas_bulk_modulus</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Fluid bulk moduli must be positive.&quot;</span><span class="p">)</span>

        <span class="n">k_fluid_eff</span> <span class="o">=</span> <span class="p">(</span><span class="n">water_bulk_modulus</span> <span class="o">-</span> <span class="n">gas_bulk_modulus</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">saturation_water</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">exponent</span><span class="p">)</span> <span class="o">+</span> <span class="n">gas_bulk_modulus</span>
        <span class="k">return</span> <span class="n">k_fluid_eff</span></div>
    
<div class="viewcode-block" id="BrieModel.calculate_saturated_modulus"><a class="viewcode-back" href="../../../api/petrophysics.html#PyHydroGeophysX.BrieModel.calculate_saturated_modulus">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_saturated_modulus</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                                  <span class="n">dry_rock_bulk_modulus</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="c1"># K_dry</span>
                                  <span class="n">mineral_bulk_modulus</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="c1"># K_mineral or K_matrix</span>
                                  <span class="n">porosity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>             <span class="c1"># φ</span>
                                  <span class="n">saturation_water</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>     <span class="c1"># S_w</span>
                                  <span class="n">water_bulk_modulus</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.2</span><span class="p">,</span> <span class="c1"># K_w</span>
                                  <span class="n">gas_bulk_modulus</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span>   <span class="c1"># K_gas</span>
                                  <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the bulk modulus of a rock saturated with a fluid mixture (water/gas)</span>
<span class="sd">        using Gassmann&#39;s equation, with the effective fluid modulus derived from Brie&#39;s model.</span>

<span class="sd">        Gassmann&#39;s equation:</span>
<span class="sd">            K_sat = K_dry + ( (1 - K_dry/K_mineral)^2 ) /</span>
<span class="sd">                            ( φ/K_fluid_eff + (1-φ)/K_mineral - K_dry/K_mineral^2 )</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            dry_rock_bulk_modulus (float): Bulk modulus of the dry rock frame (K_dry) [GPa].</span>
<span class="sd">            mineral_bulk_modulus (float): Intrinsic bulk modulus of the solid mineral matrix (K_mineral) [GPa].</span>
<span class="sd">                                          (Sometimes denoted K0 or Ks).</span>
<span class="sd">            porosity (float): Porosity of the rock (φ), ranging from 0 to 1.</span>
<span class="sd">            saturation_water (float): Water saturation (S_w), ranging from 0 to 1.</span>
<span class="sd">            water_bulk_modulus (float, optional): Bulk modulus of water (K_w) [GPa]. Defaults to 2.2 GPa.</span>
<span class="sd">            gas_bulk_modulus (float, optional): Bulk modulus of gas (K_gas) [GPa]. Defaults to 0.01 GPa.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            float: Bulk modulus of the saturated rock (K_sat) [GPa].</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If inputs are non-physical (e.g., porosity not in [0,1], K_dry &gt; K_mineral).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">porosity</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Porosity must be between 0 and 1.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dry_rock_bulk_modulus</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">mineral_bulk_modulus</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dry rock and mineral bulk moduli must be positive.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dry_rock_bulk_modulus</span> <span class="o">&gt;</span> <span class="n">mineral_bulk_modulus</span><span class="p">:</span>
            <span class="c1"># This can happen with very stiff pore-filling material or complex pore structures,</span>
            <span class="c1"># but Gassmann&#39;s assumptions might be violated. Standard assumption is K_dry &lt;= K_mineral.</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Dry rock bulk modulus is greater than mineral bulk modulus. &quot;</span>
                  <span class="s2">&quot;This is unusual for simple Gassmann application (K_dry &gt; K_mineral).&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate effective fluid bulk modulus using Brie&#39;s model</span>
        <span class="n">k_fluid_eff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_fluid_modulus</span><span class="p">(</span>
            <span class="n">saturation_water</span><span class="p">,</span> <span class="n">water_bulk_modulus</span><span class="p">,</span> <span class="n">gas_bulk_modulus</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">k_fluid_eff</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Should not happen if component moduli are positive</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculated effective fluid modulus is non-positive (</span><span class="si">{</span><span class="n">k_fluid_eff</span><span class="si">}</span><span class="s2"> GPa), check inputs to Brie&#39;s model.&quot;</span><span class="p">)</span>

        <span class="c1"># Apply Gassmann&#39;s equation for K_sat</span>
        <span class="c1"># K_sat = K_dry + num / den</span>
        <span class="c1"># num = (1 - K_dry/K_mineral)^2</span>
        <span class="c1"># den = phi/K_fluid_eff + (1-phi)/K_mineral - K_dry/(K_mineral^2)</span>
        
        <span class="c1"># Avoid division by zero if K_mineral or K_fluid_eff is zero (already checked mostly).</span>
        <span class="c1"># Also, (K_mineral - K_dry) in the denominator of the original formulation was problematic.</span>
        <span class="c1"># Using the common form of Gassmann&#39;s:</span>
        <span class="n">term_kdry_over_kmin</span> <span class="o">=</span> <span class="n">dry_rock_bulk_modulus</span> <span class="o">/</span> <span class="n">mineral_bulk_modulus</span>
        
        <span class="n">numerator_gassmann</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">term_kdry_over_kmin</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">denominator_gassmann</span> <span class="o">=</span> <span class="p">(</span><span class="n">porosity</span> <span class="o">/</span> <span class="n">k_fluid_eff</span><span class="p">)</span> <span class="o">+</span> \
                               <span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">porosity</span><span class="p">)</span> <span class="o">/</span> <span class="n">mineral_bulk_modulus</span><span class="p">)</span> <span class="o">-</span> \
                               <span class="p">(</span><span class="n">dry_rock_bulk_modulus</span> <span class="o">/</span> <span class="p">(</span><span class="n">mineral_bulk_modulus</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">denominator_gassmann</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="c1"># This case implies K_sat could be infinite or undefined, usually due to K_fluid_eff being very small</span>
            <span class="c1"># relative to porosity, or specific combinations of K_dry, K_mineral, phi.</span>
            <span class="c1"># If K_dry = K_mineral (zero porosity rock frame), then K_sat = K_mineral.</span>
            <span class="c1"># If phi = 0, then K_sat = K_mineral (or K_dry if K_dry used as proxy for K_mineral).</span>
            <span class="c1"># If K_fluid_eff is extremely small (like gas), then K_sat approaches K_dry.</span>
            <span class="c1"># For a robust solution, one might need to check limits or specific conditions.</span>
            <span class="c1"># If K_dry = K_mineral, numerator is 0, K_sat = K_dry = K_mineral.</span>
            <span class="c1"># If denominator is zero, it often implies K_sat approaches K_mineral if K_dry is less than K_mineral.</span>
            <span class="c1"># If K_dry is very stiff, this can be an issue.</span>
            <span class="c1"># For now, if denominator is zero, it might be better to return K_mineral or raise error.</span>
            <span class="c1"># If K_dry = K_mineral, numerator is 0, K_sat = K_dry = K_mineral.</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">dry_rock_bulk_modulus</span><span class="p">,</span> <span class="n">mineral_bulk_modulus</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">mineral_bulk_modulus</span> <span class="c1"># Or dry_rock_bulk_modulus</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This indicates a problem, K_sat would be infinite.</span>
                <span class="c1"># Could be due to K_fluid_eff being extremely low and other terms aligning.</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Gassmann equation denominator is zero, leading to undefined K_sat. Check input parameters.&quot;</span><span class="p">)</span>

        <span class="n">k_sat</span> <span class="o">=</span> <span class="n">dry_rock_bulk_modulus</span> <span class="o">+</span> <span class="n">numerator_gassmann</span> <span class="o">/</span> <span class="n">denominator_gassmann</span>
        <span class="k">return</span> <span class="n">k_sat</span></div></div>


<div class="viewcode-block" id="DEMModel"><a class="viewcode-back" href="../../../api/petrophysics.html#PyHydroGeophysX.DEMModel">[docs]</a><span class="k">class</span> <span class="nc">DEMModel</span><span class="p">(</span><span class="n">BaseVelocityModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Differential Effective Medium (DEM) model for calculating elastic properties</span>
<span class="sd">    and seismic velocities of porous rocks.</span>

<span class="sd">    This model simulates the incremental addition of pore space (filled with fluid)</span>
<span class="sd">    into a solid matrix, updating the effective moduli at each step.</span>
<span class="sd">    It requires solving differential equations, often approximated by numerical iteration</span>
<span class="sd">    or specific solutions for certain pore geometries (like spheroids with aspect ratio α).</span>
<span class="sd">    The implementation here appears to solve for K_eff and G_eff using root finding</span>
<span class="sd">    on implicit equations derived from DEM theory for specific inclusion types.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="DEMModel.__init__"><a class="viewcode-back" href="../../../api/petrophysics.html#PyHydroGeophysX.DEMModel.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize DEM model.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span></div>
        <span class="c1"># Specific parameters for DEM (like pore aspect ratio) are passed to calculate_velocity.</span>
    
<div class="viewcode-block" id="DEMModel.calculate_velocity"><a class="viewcode-back" href="../../../api/petrophysics.html#PyHydroGeophysX.DEMModel.calculate_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                         <span class="n">porosity</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>       <span class="c1"># φ, array of porosity values</span>
                         <span class="n">saturation</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>    <span class="c1"># S_w, array of water saturation values</span>
                         <span class="n">matrix_bulk_modulus</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>  <span class="c1"># K_matrix (Km) in GPa</span>
                         <span class="n">matrix_shear_modulus</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="c1"># G_matrix (Gm) in GPa</span>
                         <span class="n">matrix_density</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>       <span class="c1"># ρ_matrix in kg/m³</span>
                         <span class="n">aspect_ratio</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>   <span class="c1"># α, pore aspect ratio</span>
                         <span class="n">water_bulk_modulus</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.2</span><span class="p">,</span> <span class="c1"># K_w in GPa</span>
                         <span class="n">gas_bulk_modulus</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>  <span class="c1"># K_gas (e.g., air) in GPa</span>
                         <span class="n">water_density</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="c1"># ρ_w in kg/m³</span>
                         <span class="n">gas_density</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.225</span>   <span class="c1"># ρ_gas (e.g., air) in kg/m³</span>
                         <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate effective bulk (K_eff) and shear (G_eff) moduli, and P-wave velocity (Vp)</span>
<span class="sd">        using a Differential Effective Medium (DEM) model.</span>

<span class="sd">        The method iterates through each porosity/saturation point, calculates the</span>
<span class="sd">        effective fluid properties using Brie&#39;s model, then solves implicit DEM</span>
<span class="sd">        equations numerically for K_eff and G_eff.</span>

<span class="sd">        Args:</span>
<span class="sd">            porosity (np.ndarray): Array of porosity values (φ) [m³/m³].</span>
<span class="sd">            saturation (np.ndarray): Array of water saturation values (S_w) [m³/m³].</span>
<span class="sd">                                     Must be same length as `porosity`.</span>
<span class="sd">            matrix_bulk_modulus (float): Bulk modulus of the solid mineral matrix (K_m) [GPa].</span>
<span class="sd">            matrix_shear_modulus (float): Shear modulus of the solid mineral matrix (G_m) [GPa].</span>
<span class="sd">            matrix_density (float): Density of the solid mineral matrix (ρ_m) [kg/m³].</span>
<span class="sd">            aspect_ratio (float, optional): Aspect ratio (α) of the pores/cracks.</span>
<span class="sd">                                            Defaults to 0.1 (oblate spheroids).</span>
<span class="sd">            water_bulk_modulus (float, optional): Bulk modulus of water (K_w) [GPa]. Defaults to 2.2 GPa.</span>
<span class="sd">            gas_bulk_modulus (float, optional): Bulk modulus of gas (K_gas) [GPa]. Defaults to 0.01 GPa.</span>
<span class="sd">            water_density (float, optional): Density of water (ρ_w) [kg/m³]. Defaults to 1000 kg/m³.</span>
<span class="sd">            gas_density (float, optional): Density of gas (ρ_gas) [kg/m³]. Defaults to 1.225 kg/m³.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Tuple[np.ndarray, np.ndarray, np.ndarray]: Contains:</span>
<span class="sd">                - K_eff (np.ndarray): Effective bulk modulus for each porosity/saturation point [GPa].</span>
<span class="sd">                - G_eff (np.ndarray): Effective shear modulus for each porosity/saturation point [GPa].</span>
<span class="sd">                - Vp (np.ndarray): P-wave velocity for each porosity/saturation point [m/s].</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If root finding for K_eff or G_eff fails for any point, or if input array</span>
<span class="sd">                        lengths for porosity and saturation do not match.</span>
<span class="sd">            TypeError: If inputs are not of expected types.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">porosity</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">saturation</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Porosity and saturation must be NumPy arrays.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">porosity</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">saturation</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Porosity and saturation arrays must have the same shape.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">porosity</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">saturation</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">):</span>
             <span class="c1"># Element-wise check is better if only some values are out of [0,1] range.</span>
             <span class="c1"># This simplified check flags if *all* are not in range, which is too loose.</span>
             <span class="c1"># Better: if np.any((porosity &lt; 0) | (porosity &gt; 1)) or np.any((saturation &lt; 0) | (saturation &gt; 1)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Porosity or saturation values are outside the typical [0,1] range.&quot;</span><span class="p">)</span>


        <span class="n">num_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">porosity</span><span class="p">)</span>
        <span class="n">K_eff_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_points</span><span class="p">)</span>
        <span class="n">G_eff_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_points</span><span class="p">)</span>
        <span class="n">Vp_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_points</span><span class="p">)</span>
        
        <span class="c1"># Brie model for effective fluid properties</span>
        <span class="n">brie_model</span> <span class="o">=</span> <span class="n">BrieModel</span><span class="p">()</span> <span class="c1"># Using default exponent 3.0 from BrieModel class</span>

        <span class="c1"># Initial matrix properties (K_m, G_m)</span>
        <span class="n">K_m</span> <span class="o">=</span> <span class="n">matrix_bulk_modulus</span>
        <span class="n">G_m</span> <span class="o">=</span> <span class="n">matrix_shear_modulus</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_points</span><span class="p">):</span>
            <span class="n">phi_i</span> <span class="o">=</span> <span class="n">porosity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">sat_i</span> <span class="o">=</span> <span class="n">saturation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># Calculate effective fluid bulk modulus (K_f) for current saturation</span>
            <span class="c1"># using Brie&#39;s model. Shear modulus of fluid (G_f) is assumed to be 0.</span>
            <span class="n">K_f_eff</span> <span class="o">=</span> <span class="n">brie_model</span><span class="o">.</span><span class="n">calculate_fluid_modulus</span><span class="p">(</span><span class="n">sat_i</span><span class="p">,</span> <span class="n">water_bulk_modulus</span><span class="p">,</span> <span class="n">gas_bulk_modulus</span><span class="p">)</span>
            <span class="n">G_f_eff</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># Fluids do not support static shear stress.</span>
            
            <span class="c1"># Calculate Poisson&#39;s ratio of the current effective medium (initially matrix)</span>
            <span class="c1"># This v is for the *matrix into which pores are being inserted*.</span>
            <span class="c1"># In DEM, the &quot;matrix&quot; properties evolve. This v should be K_m, G_m at phi=0.</span>
            <span class="c1"># For subsequent steps (if DEM were iterative), this v would use K_eff, G_eff from previous step.</span>
            <span class="c1"># The current formulation seems to use initial K_m, G_m for &#39;v&#39; throughout,</span>
            <span class="c1"># which is typical if the DEM equations are solved for a target porosity phi_i directly</span>
            <span class="c1"># from initial matrix, rather than incrementally building up porosity.</span>
            <span class="c1"># The equations solved for Keff and Geff seem to be integrated forms of DEM.</span>
            
            <span class="c1"># Poisson&#39;s ratio of the solid matrix material</span>
            <span class="n">v_matrix</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">K_m</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">G_m</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">K_m</span> <span class="o">+</span> <span class="n">G_m</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">&lt;</span> <span class="n">v_matrix</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">):</span> <span class="c1"># Physical bounds for Poisson&#39;s ratio</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Calculated matrix Poisson&#39;s ratio (</span><span class="si">{</span><span class="n">v_matrix</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">) is outside physical bounds (-1 to 0.5) at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="c1"># DEM parameters (P, Q or b, c, d, g in this code) depend on pore geometry (aspect_ratio)</span>
            <span class="c1"># and properties of the matrix (K_m, G_m, v_matrix) and inclusion (K_f_eff, G_f_eff=0).</span>
            <span class="c1"># The terms b, c, d, g are derived from Eshelby-Wu type tensors for spheroidal inclusions.</span>
            <span class="c1"># These specific forms appear in Berryman&#39;s DEM papers or related works.</span>
            <span class="c1"># (Using v_matrix for these calculations)</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">aspect_ratio</span>
            <span class="c1"># Parameter &#39;b&#39; (related to P_ijkl tensor components for bulk modulus change)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v_matrix</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">v_matrix</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            
            <span class="c1"># Parameter &#39;c&#39; and &#39;d&#39; (related to Q_ijkl tensor components for shear modulus change)</span>
            <span class="c1"># The two-step `c = 1/c` is unusual; it implies `c_orig = 5 / ((3 + ...))`.</span>
            <span class="c1"># These are specific to certain DEM formulations (e.g. Kuster-Toksoz like terms in DEM context).</span>
            <span class="c1"># (Using v_matrix for these calculations)</span>
            <span class="c1"># Original code: c = 1 / 5 * ((3 + 8 * (1 - v_matrix) / (np.pi * alpha * (2 - v_matrix)))); c = 1 / c</span>
            <span class="c1"># This is equivalent to: c_temp = (1/5) * term; c = 1 / c_temp = 5 / term.</span>
            <span class="c1"># Let&#39;s rewrite for clarity and to match DEMModel class if that was intended.</span>
            <span class="c1"># The DEMModel class has: c = 1.0 / (0.2 * c_inv_term) where c_inv_term is ((3 + ...))</span>
            <span class="c1"># This is c = 5.0 / c_inv_term. This seems consistent.</span>
            <span class="n">c_inv_term</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">v_matrix</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">v_matrix</span><span class="p">)))</span>
            <span class="n">c</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="o">/</span> <span class="n">c_inv_term</span> <span class="k">if</span> <span class="n">c_inv_term</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> 
            
            <span class="n">d_inv_term</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">v_matrix</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> <span class="o">-</span> <span class="n">v_matrix</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">v_matrix</span><span class="p">)))</span>
            <span class="n">d</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="o">/</span> <span class="n">d_inv_term</span> <span class="k">if</span> <span class="n">d_inv_term</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            
            <span class="c1"># Parameter &#39;g&#39;</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">v_matrix</span><span class="p">))</span>
            
            <span class="c1"># Define implicit equation for effective bulk modulus K_eff from DEM:</span>
            <span class="c1"># (K_eff - K_f) / (K_m - K_f) * (K_m / K_eff)^(1 / (1 + b)) = (1 - φ)^(1 / (1 + b))</span>
            <span class="c1"># This is a form of Berryman&#39;s DEM solution for K_eff.</span>
            <span class="k">def</span> <span class="nf">dem_eq_Keff</span><span class="p">(</span><span class="n">Keff_trial</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">Keff_trial</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="mf">1e12</span> <span class="c1"># Penalty for non-physical K_eff</span>
                <span class="c1"># Avoid division by zero if K_m == K_f_eff</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">K_m</span><span class="p">,</span> <span class="n">K_f_eff</span><span class="p">):</span> <span class="c1"># Matrix and fluid are same, K_eff should be K_m (or K_f_eff)</span>
                    <span class="k">return</span> <span class="n">Keff_trial</span> <span class="o">-</span> <span class="n">K_m</span> <span class="c1"># Should be zero if Keff_trial = K_m</span>
                
                <span class="c1"># Avoid Keff_trial being zero if K_m/Keff_trial is raised to a power.</span>
                <span class="c1"># If K_f_eff is very small (gas), Keff_trial might also be small.</span>
                <span class="c1"># The term (K_m / Keff_trial) can be large.</span>
                <span class="c1"># If Keff_trial approaches K_f_eff, LHS can be tricky.</span>
                <span class="c1"># If Keff_trial = K_f_eff, LHS = 0. RHS = (1-phi)^(1/(1+b)). So K_f_eff is a root if phi makes RHS zero (phi=1).</span>
                <span class="c1"># This form assumes K_m != K_f.</span>
                
                <span class="c1"># Original form: (Keff_val - Kf) / (bulk_modulus - Kf) * (bulk_modulus / Keff_val)**(1 / (1 + b)) - (1 - porosity[ii])**(1 / (1 + b))</span>
                <span class="c1"># Here, bulk_modulus is K_m. Kf is K_f_eff. porosity[ii] is phi_i.</span>
                <span class="c1"># Keff_val is Keff_trial.</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">K_m</span><span class="p">,</span> <span class="n">K_f_eff</span><span class="p">):</span> <span class="c1"># If matrix and fluid are indistinguishable</span>
                    <span class="c1"># Then K_eff should also be K_m (or K_f_eff)</span>
                    <span class="c1"># The equation simplifies to: (K_eff - K_m) * (K_m/K_eff)^X = 0</span>
                    <span class="c1"># This means K_eff = K_m is a solution.</span>
                    <span class="c1"># If K_m = K_f, then DEM implies K_eff = K_m for any porosity.</span>
                    <span class="k">return</span> <span class="n">Keff_trial</span> <span class="o">-</span> <span class="n">K_m</span>

                <span class="n">lhs</span> <span class="o">=</span> <span class="p">(</span><span class="n">Keff_trial</span> <span class="o">-</span> <span class="n">K_f_eff</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">K_m</span> <span class="o">-</span> <span class="n">K_f_eff</span><span class="p">)</span> <span class="o">*</span> \
                      <span class="p">(</span><span class="n">K_m</span> <span class="o">/</span> <span class="n">Keff_trial</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">b</span><span class="p">))</span>
                <span class="n">rhs</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">phi_i</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">b</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">lhs</span> <span class="o">-</span> <span class="n">rhs</span>
            
            <span class="c1"># Numerically solve for K_eff. Initial guess K_m.</span>
            <span class="c1"># `method=&#39;lm&#39;` is Levenberg-Marquardt, suitable for non-linear least squares,</span>
            <span class="c1"># often robust for root finding too.</span>
            <span class="n">sol_K</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="n">dem_eq_Keff</span><span class="p">,</span> <span class="n">K_m</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;lm&#39;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span> <span class="c1"># Add tolerance</span>
            <span class="k">if</span> <span class="n">sol_K</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="n">sol_K</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">K_eff_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_K</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Potential Issue: Solver failure. Could try different initial guess or method,</span>
                <span class="c1"># or indicate failure (e.g., with NaN or by raising error).</span>
                <span class="c1"># Original code raises ValueError.</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEM root finding for K_eff failed at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> for porosity </span><span class="si">{</span><span class="n">phi_i</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, sat </span><span class="si">{</span><span class="n">sat_i</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">. Message: </span><span class="si">{</span><span class="n">sol_K</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Define implicit equation for effective shear modulus G_eff from DEM:</span>
            <span class="c1"># G_eff / G_m * ( (1/G_eff + c*g/(d*K_f_eff)) / (1/G_m + c*g/(d*K_f_eff)) )^(1 - c/d) = (1 - φ)^(1/d)</span>
            <span class="c1"># This is complex. Note G_f_eff = 0. Term c*g/(d*K_f_eff) involves K_f_eff.</span>
            <span class="c1"># If K_f_eff (fluid bulk modulus) is very small (gas), this term can be large.</span>
            <span class="c1"># If K_f_eff = 0 (not possible as default is 0.01 GPa), it&#39;s infinite.</span>
            <span class="c1"># The original `velDEM` has `Kf` (which is K_f_eff here) in the denominator.</span>
            <span class="c1"># This implies the fluid&#39;s incompressibility affects shear properties if pores are not dry.</span>
            <span class="c1"># This specific form of G_eff DEM equation seems less common or for specific assumptions.</span>
            <span class="c1"># Often, for G_eff, the fluid term (K_f_eff) might not appear if G_f_eff=0 is directly used.</span>
            <span class="c1"># Let&#39;s assume K_f_eff is non-zero.</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">K_f_eff</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">):</span> <span class="c1"># If fluid is extremely compressible (like vacuum)</span>
                <span class="c1"># This term c*g/(d*K_f_eff) would blow up.</span>
                <span class="c1"># If K_f_eff -&gt; 0, then (1/G_eff + Inf) / (1/G_m + Inf) -&gt; 1.</span>
                <span class="c1"># So eq becomes: G_eff/G_m = (1-phi)^(1/d). This is a dry pore limit.</span>
                <span class="c1"># This suggests if Kf is very small, the equation simplifies.</span>
                <span class="c1"># Let&#39;s add a small epsilon to K_f_eff if it&#39;s zero to avoid division by zero in the main equation.</span>
                <span class="n">k_f_eff_safe</span> <span class="o">=</span> <span class="n">K_f_eff</span> <span class="k">if</span> <span class="n">K_f_eff</span> <span class="o">&gt;</span> <span class="mf">1e-9</span> <span class="k">else</span> <span class="mf">1e-9</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">k_f_eff_safe</span> <span class="o">=</span> <span class="n">K_f_eff</span>

            <span class="k">def</span> <span class="nf">dem_eq_Geff</span><span class="p">(</span><span class="n">Geff_trial</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">Geff_trial</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="mf">1e12</span> <span class="c1"># Penalty</span>
                
                <span class="c1"># Handle G_m = 0 case (e.g. if matrix was fluid - not typical for DEM solid matrix)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">G_m</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">Geff_trial</span> <span class="c1"># If matrix has no shear, effective medium should also have no shear.</span>

                <span class="n">term_in_power_num</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">Geff_trial</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">g</span> <span class="o">/</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">k_f_eff_safe</span><span class="p">))</span>
                <span class="n">term_in_power_den</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">G_m</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">g</span> <span class="o">/</span> <span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">k_f_eff_safe</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">term_in_power_den</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">):</span> <span class="c1"># Denominator inside power is zero</span>
                    <span class="c1"># This case is complex. If num is also zero, could be 1. If num non-zero, then inf.</span>
                    <span class="c1"># This would likely mean parameters are at extreme limits.</span>
                    <span class="k">return</span> <span class="mf">1e12</span> <span class="c1"># Penalize, likely indicates an issue or limit.</span>

                <span class="n">ratio_terms</span> <span class="o">=</span> <span class="n">term_in_power_num</span> <span class="o">/</span> <span class="n">term_in_power_den</span>
                <span class="n">exponent_term</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">c</span> <span class="o">/</span> <span class="n">d</span><span class="p">)</span> <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1.0</span> <span class="c1"># if d=0, exponent is ill-defined. Assume 1 for now.</span>
                                                               <span class="c1"># d being 0 implies d_inv_term was inf, meaning alpha or (1-v) was problematic.</span>

                <span class="k">if</span> <span class="n">ratio_terms</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exponent_term</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exponent_term</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
                    <span class="c1"># Cannot take fractional power of negative number without complex result.</span>
                    <span class="c1"># This implies non-physical parameters or model breakdown.</span>
                    <span class="k">return</span> <span class="mf">1e12</span> <span class="c1"># Penalize</span>
                
                <span class="n">lhs</span> <span class="o">=</span> <span class="p">(</span><span class="n">Geff_trial</span> <span class="o">/</span> <span class="n">G_m</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ratio_terms</span> <span class="o">**</span> <span class="n">exponent_term</span><span class="p">)</span>
                <span class="n">rhs</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">phi_i</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">d</span> <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1.0</span><span class="p">)</span> <span class="c1"># if d=0, rhs exponent is ill-defined.</span>
                <span class="k">return</span> <span class="n">lhs</span> <span class="o">-</span> <span class="n">rhs</span>

            <span class="n">sol_G</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="n">dem_eq_Geff</span><span class="p">,</span> <span class="n">G_m</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;lm&#39;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span> <span class="c1"># Initial guess G_m</span>
            <span class="k">if</span> <span class="n">sol_G</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="n">sol_G</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># G_eff can be 0 for suspensions</span>
                <span class="n">G_eff_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_G</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># print(f&quot;Warning: DEM root finding for G_eff failed or gave negative result at index {i} for porosity {phi_i:.3f}, sat {sat_i:.3f}. Message: {sol_G.message}. G_eff set to 0.&quot;)</span>
                <span class="c1"># Setting to 0.0 if DEM fails for shear, as it might be close to fluid suspension.</span>
                <span class="c1"># Original code raises ValueError.</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEM root finding for G_eff failed at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> for porosity </span><span class="si">{</span><span class="n">phi_i</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, sat </span><span class="si">{</span><span class="n">sat_i</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">. Message: </span><span class="si">{</span><span class="n">sol_G</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Calculate effective density (ρ_eff) of the saturated rock</span>
            <span class="c1"># ρ_eff = ρ_matrix * (1-φ) + ρ_fluid * φ</span>
            <span class="c1"># ρ_fluid = S_w * ρ_w + (1-S_w) * ρ_gas</span>
            <span class="n">rho_fluid_eff</span> <span class="o">=</span> <span class="n">sat_i</span> <span class="o">*</span> <span class="n">water_density</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">sat_i</span><span class="p">)</span> <span class="o">*</span> <span class="n">gas_density</span>
            <span class="n">rho_total_eff</span> <span class="o">=</span> <span class="n">matrix_density</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">phi_i</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho_fluid_eff</span> <span class="o">*</span> <span class="n">phi_i</span>
            
            <span class="k">if</span> <span class="n">rho_total_eff</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculated total effective density is non-positive (</span><span class="si">{</span><span class="n">rho_total_eff</span><span class="si">}</span><span class="s2"> kg/m³) at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="c1"># Calculate P-wave velocity (Vp = sqrt((K_eff + 4/3*G_eff) / ρ_eff))</span>
            <span class="c1"># Moduli are in GPa, so multiply by 1e9 for Pascals.</span>
            <span class="n">p_wave_modulus_eff</span> <span class="o">=</span> <span class="n">K_eff_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="o">+</span> <span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">G_eff_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span>
            <span class="k">if</span> <span class="n">p_wave_modulus_eff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                 <span class="c1"># This can happen if K_eff or G_eff are not well-behaved from solver.</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Calculated P-wave modulus is negative (</span><span class="si">{</span><span class="n">p_wave_modulus_eff</span><span class="si">}</span><span class="s2"> Pa) at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. Setting Vp to NaN.&quot;</span><span class="p">)</span>
                <span class="n">Vp_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Vp_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_wave_modulus_eff</span> <span class="o">/</span> <span class="n">rho_total_eff</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">K_eff_results</span><span class="p">,</span> <span class="n">G_eff_results</span><span class="p">,</span> <span class="n">Vp_results</span></div></div>


<div class="viewcode-block" id="HertzMindlinModel"><a class="viewcode-back" href="../../../api/petrophysics.html#PyHydroGeophysX.HertzMindlinModel">[docs]</a><span class="k">class</span> <span class="nc">HertzMindlinModel</span><span class="p">(</span><span class="n">BaseVelocityModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Hertz-Mindlin model for contact stiffness of granular media, often combined with</span>
<span class="sd">    Hashin-Shtrikman bounds to estimate effective moduli of porous rocks.</span>

<span class="sd">    This model calculates the elastic moduli (K_HM, G_HM) of a dense random pack</span>
<span class="sd">    of identical elastic spheres at a critical porosity (φ_c). These are then used</span>
<span class="sd">    with Hashin-Shtrikman bounds (or other schemes) to estimate moduli at other porosities.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="HertzMindlinModel.__init__"><a class="viewcode-back" href="../../../api/petrophysics.html#PyHydroGeophysX.HertzMindlinModel.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
               <span class="n">critical_porosity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span> 
               <span class="n">coordination_number</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">6.0</span><span class="p">):</span> <span class="c1"># Typical C for random pack can be 6-9. Original had 4.</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize Hertz-Mindlin model parameters.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            critical_porosity (float, optional): Critical porosity (φ_c), typically the porosity</span>
<span class="sd">                                                 of a dense random pack of spheres (e.g., 0.36-0.4).</span>
<span class="sd">                                                 Defaults to 0.4.</span>
<span class="sd">            coordination_number (float, optional): Average number of contacts per grain (C)</span>
<span class="sd">                                                   at critical porosity. Defaults to 6.0.</span>
<span class="sd">                                                   (Original code had 4.0, which is low for sphere packs).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">critical_porosity</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Critical porosity must be between 0 and 1.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coordination_number</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Coordination number must be positive.&quot;</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">critical_porosity</span> <span class="o">=</span> <span class="n">critical_porosity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coordination_number</span> <span class="o">=</span> <span class="n">coordination_number</span></div>
    
<div class="viewcode-block" id="HertzMindlinModel.calculate_velocity"><a class="viewcode-back" href="../../../api/petrophysics.html#PyHydroGeophysX.HertzMindlinModel.calculate_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                         <span class="n">porosity</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>       <span class="c1"># φ, array of current porosities</span>
                         <span class="n">saturation</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>    <span class="c1"># S_w, array of water saturations</span>
                         <span class="n">matrix_bulk_modulus</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>  <span class="c1"># K_m of solid grains [GPa]</span>
                         <span class="n">matrix_shear_modulus</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="c1"># G_m of solid grains [GPa]</span>
                         <span class="n">matrix_density</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>       <span class="c1"># ρ_m of solid grains [kg/m³]</span>
                         <span class="n">depth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>          <span class="c1"># Depth for pressure calc [m]</span>
                         <span class="n">water_bulk_modulus</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.2</span><span class="p">,</span> <span class="c1"># K_w [GPa]</span>
                         <span class="n">gas_bulk_modulus</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>  <span class="c1"># K_gas [GPa]</span>
                         <span class="n">water_density</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="c1"># ρ_w [kg/m³]</span>
                         <span class="n">gas_density</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.225</span>   <span class="c1"># ρ_gas [kg/m³]</span>
                         <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate P-wave velocity bounds (Hashin-Shtrikman high and low) for porous rocks</span>
<span class="sd">        using Hertz-Mindlin theory for dry frame moduli at critical porosity, and then</span>
<span class="sd">        interpolating/extrapolating these moduli for other porosities. Fluid substitution</span>
<span class="sd">        is applied using Brie&#39;s model for effective fluid modulus.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            porosity (np.ndarray): Array of porosity values (φ).</span>
<span class="sd">            saturation (np.ndarray): Array of water saturation values (S_w).</span>
<span class="sd">            matrix_bulk_modulus (float): Bulk modulus of the solid mineral matrix (K_m) [GPa].</span>
<span class="sd">            matrix_shear_modulus (float): Shear modulus of the solid mineral matrix (G_m) [GPa].</span>
<span class="sd">            matrix_density (float): Density of the solid mineral matrix (ρ_m) [kg/m³].</span>
<span class="sd">            depth (float, optional): Depth for effective pressure estimation [m]. Defaults to 1.0 m.</span>
<span class="sd">                                     Pressure calculation is simplified.</span>
<span class="sd">            water_bulk_modulus (float, optional): Bulk modulus of water (K_w) [GPa]. Defaults to 2.2 GPa.</span>
<span class="sd">            gas_bulk_modulus (float, optional): Bulk modulus of gas (K_gas) [GPa]. Defaults to 0.01 GPa.</span>
<span class="sd">            water_density (float, optional): Density of water (ρ_w) [kg/m³]. Defaults to 1000 kg/m³.</span>
<span class="sd">            gas_density (float, optional): Density of gas (ρ_gas) [kg/m³]. Defaults to 1.225 kg/m³.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            Tuple[np.ndarray, np.ndarray]:</span>
<span class="sd">                - Vp_high (np.ndarray): P-wave velocity upper bound [m/s].</span>
<span class="sd">                - Vp_low (np.ndarray): P-wave velocity lower bound [m/s].</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If input parameters are non-physical or lead to invalid intermediate calculations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">porosity</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">saturation</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Porosity and saturation must be NumPy arrays.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">porosity</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">saturation</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Porosity and saturation arrays must have the same shape.&quot;</span><span class="p">)</span>
        <span class="c1"># Add checks for physical ranges of moduli and densities if needed.</span>

        <span class="c1"># Poisson&#39;s ratio of the solid mineral matrix</span>
        <span class="n">v_matrix</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">matrix_bulk_modulus</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">matrix_shear_modulus</span><span class="p">)</span> <span class="o">/</span> \
                   <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">matrix_bulk_modulus</span> <span class="o">+</span> <span class="n">matrix_shear_modulus</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">&lt;</span> <span class="n">v_matrix</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Matrix Poisson&#39;s ratio (</span><span class="si">{</span><span class="n">v_matrix</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">) is outside physical bounds (-1 to 0.5).&quot;</span><span class="p">)</span>

        <span class="c1"># Effective pressure (P_eff) estimation [GPa]</span>
        <span class="c1"># Simplified: (ρ_matrix - ρ_water_avg) * g * depth. Assumes hydrostatic pore pressure.</span>
        <span class="c1"># (1000 kg/m³ is approx density of water, used as reference for buoyancy).</span>
        <span class="c1"># This is a very rough estimate and might need refinement for specific scenarios.</span>
        <span class="c1"># Potential Issue: If matrix_density &lt; 1000 (e.g., ice), pressure could be negative.</span>
        <span class="c1"># Pressure should ideally be effective pressure (confining - pore).</span>
        <span class="c1"># Let&#39;s ensure pressure P is non-negative for Hertz-Mindlin equations.</span>
        <span class="n">effective_pressure_gpa</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">matrix_density</span> <span class="o">-</span> <span class="n">water_density</span><span class="p">)</span> <span class="o">*</span> <span class="mf">9.80665</span> <span class="o">*</span> <span class="n">depth</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">effective_pressure_gpa</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Effective pressure is zero or negative. Hertz-Mindlin moduli will be zero. &quot;</span>
                  <span class="s2">&quot;This occurs if matrix_density &lt;= water_density or depth is zero.&quot;</span><span class="p">)</span>
            <span class="c1"># If P=0, K_HM and G_HM will be 0. This leads to Vp=0 for dry frame.</span>
            <span class="c1"># Fluid substitution might still yield non-zero Vp if K_fluid is non-zero.</span>

        <span class="c1"># Hertz-Mindlin model moduli at critical porosity (φ_c)</span>
        <span class="n">C_coord_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordination_number</span>
        <span class="n">phi_critical</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">critical_porosity</span>
        
        <span class="c1"># K_HM (Bulk modulus of dry frame at critical porosity)</span>
        <span class="c1"># K_HM = [ C^2 * (1-φ_c)^2 * G_m^2 * P_eff / (18 * π^2 * (1-v_m)^2) ]^(1/3)</span>
        <span class="c1"># Ensure (1-v_m)^2 is not zero. v_m = 0.5 leads to this.</span>
        <span class="n">denominator_khm_term</span> <span class="o">=</span> <span class="p">(</span><span class="mi">18</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">v_matrix</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">denominator_khm_term</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">):</span>
            <span class="c1"># This implies v_matrix is 1.0, which is non-physical for stable isotropic material.</span>
            <span class="c1"># It would make K_HM infinite if P_eff &gt; 0.</span>
            <span class="c1"># If P_eff = 0, K_HM = 0 anyway.</span>
            <span class="c1"># For v_matrix=0.5 (incompressible solid), K_m is inf. This formula assumes finite K_m, G_m.</span>
            <span class="c1"># If v_matrix is very close to 1, K_HM can be very large.</span>
            <span class="c1"># If v_matrix = 0.5 (incompressible grains, K_m -&gt; inf), then (1-v_matrix)^2 = 0.25.</span>
            <span class="c1"># The issue is if v_matrix = 1.0.</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Matrix Poisson&#39;s ratio v_m=</span><span class="si">{</span><span class="n">v_matrix</span><span class="si">}</span><span class="s2"> leads to division by zero in K_HM calculation.&quot;</span><span class="p">)</span>
        
        <span class="n">K_HM_dry_critical</span> <span class="o">=</span> <span class="p">(</span><span class="n">C_coord_num</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">phi_critical</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">matrix_shear_modulus</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">effective_pressure_gpa</span> <span class="o">/</span>
                             <span class="n">denominator_khm_term</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="n">effective_pressure_gpa</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
        
        <span class="c1"># G_HM (Shear modulus of dry frame at critical porosity)</span>
        <span class="c1"># G_HM = [(5-4v_m)/(5(2-v_m))] * [ (3 * C^2 * (1-φ_c)^2 * G_m^2 * P_eff) / (2 * π^2 * (1-v_m)^2) ]^(1/3)</span>
        <span class="c1"># Note: Original has (10-2*v) which is 2*(5-v). Simpler form often (5-4v_m)/(5(2-v_m)).</span>
        <span class="c1"># The term ( (3 * C^2 ...) / (2 * pi^2 * (1-v_m)^2) ) ^ (1/3) is related to K_HM.</span>
        <span class="c1"># G_HM = Factor * ( (K_HM_numerator_part_scaled_for_G) ) ^ (1/3)</span>
        <span class="c1"># Let&#39;s use K_HM to simplify G_HM: G_HM = ( (5-4v)/(5(2-v)) ) * (3/2 * K_HM_from_shear_term_relation)</span>
        <span class="c1"># Factor = (5 - 4*v_matrix) / (5 * (2 - v_matrix)) -- this is a common pre-factor.</span>
        <span class="c1"># The term ((3*C^2...)/ (2*pi^2...)) can be related to K_HM&#39;s term.</span>
        <span class="c1"># K_HM_term_cubed = C^2*(1-phi_c)^2*G_m^2*P / (18*pi^2*(1-v_m)^2)</span>
        <span class="c1"># G_HM_term_cubed = (3*C^2*(1-phi_c)^2*G_m^2*P) / (2*pi^2*(1-v_m)^2) = 27 * K_HM_term_cubed</span>
        <span class="c1"># So, (G_HM_term_cubed)^(1/3) = 3 * K_HM.</span>
        <span class="c1"># G_HM = Factor_G * 3 * K_HM -- Check this derivation.</span>
        <span class="c1"># Original formula for G_HM:</span>
        <span class="c1"># G_HM = ((5 - 4v) / (10 - 2v)) * [ (3 * C^2 * (1-phi_c)^2 * G_m^2 * P) / (2 * pi^2 * (1-v_m)^2) ]^(1/3)</span>
        <span class="c1"># This is equivalent to: G_HM = ((5-4v_m)/(10-2*v_m)) * ( (9*matrix_shear_modulus)/(1-phi_c) * K_HM_dry_critical * (1-phi_c)/matrix_shear_modulus )</span>
        <span class="c1"># G_HM = ((5-4*v_matrix) / (5*(2-v_matrix))) * ( (3 * C_coord_num**2 * (1-phi_critical)**2 * matrix_shear_modulus**2 * effective_pressure_gpa) / (2*np.pi**2 * (1-v_matrix)**2) )**(1/3)</span>
        <span class="c1"># This seems more direct from literature.</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">v_matrix</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">v_matrix</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">):</span> <span class="c1"># Avoid division by zero if v_m=2 or v_m=1</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Matrix Poisson&#39;s ratio v_m=</span><span class="si">{</span><span class="n">v_matrix</span><span class="si">}</span><span class="s2"> leads to division by zero in G_HM calculation.&quot;</span><span class="p">)</span>

        <span class="n">g_hm_bracket_term_cubed</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">C_coord_num</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">phi_critical</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">matrix_shear_modulus</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">effective_pressure_gpa</span><span class="p">)</span> <span class="o">/</span> \
                            <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">v_matrix</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">v_matrix</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span> <span class="c1"># Avoid div by zero if v_m=1</span>
        <span class="n">G_HM_dry_critical</span> <span class="o">=</span> <span class="p">((</span><span class="mi">5</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">v_matrix</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">v_matrix</span><span class="p">)))</span> <span class="o">*</span> <span class="p">(</span><span class="n">g_hm_bracket_term_cubed</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="n">effective_pressure_gpa</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>

        <span class="c1"># Initialize output velocity arrays</span>
        <span class="n">Vp_high_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">porosity</span><span class="p">))</span>
        <span class="n">Vp_low_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">porosity</span><span class="p">))</span>
        
        <span class="c1"># Brie model instance for fluid substitution in Gassmann</span>
        <span class="c1"># Using default exponent from BrieModel class (typically 3.0)</span>
        <span class="n">brie</span> <span class="o">=</span> <span class="n">BrieModel</span><span class="p">(</span><span class="n">exponent</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span> <span class="c1"># Can make exponent a parameter of HertzMindlinModel if needed</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">porosity</span><span class="p">)):</span>
            <span class="n">phi_i</span> <span class="o">=</span> <span class="n">porosity</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">sat_i</span> <span class="o">=</span> <span class="n">saturation</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            
            <span class="c1"># Validate current porosity and saturation</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">phi_i</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Porosity phi_i=</span><span class="si">{</span><span class="n">phi_i</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> is outside [0,1]. Results may be non-physical. Setting Vp to NaN.&quot;</span><span class="p">)</span>
                <span class="n">Vp_high_results</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Vp_low_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">sat_i</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Saturation sat_i=</span><span class="si">{</span><span class="n">sat_i</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> is outside [0,1]. Results may be non-physical. Setting Vp to NaN.&quot;</span><span class="p">)</span>
                <span class="n">Vp_high_results</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Vp_low_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">continue</span>

            <span class="n">K_eff_dry_H</span><span class="p">,</span> <span class="n">G_eff_dry_H</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span> <span class="c1"># Effective dry rock moduli, Hashin-Shtrikman Upper</span>
            <span class="n">K_eff_dry_L</span><span class="p">,</span> <span class="n">G_eff_dry_L</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span> <span class="c1"># Effective dry rock moduli, Hashin-Shtrikman Lower</span>

            <span class="k">if</span> <span class="n">phi_i</span> <span class="o">&lt;</span> <span class="n">phi_critical</span><span class="p">:</span>
                <span class="c1"># Porosity &lt; critical: Modified Hashin-Shtrikman bounds (interpolate between matrix and critical point)</span>
                <span class="c1"># These are for the DRY rock frame.</span>
                <span class="c1"># K_eff_L_dry = [ (φ/φ_c) / (K_HM + 4/3 G_HM) + (1 - φ/φ_c) / (K_m + 4/3 G_HM) ]^-1 - 4/3 G_HM</span>
                <span class="c1"># G_eff_L_dry = [ (φ/φ_c) / (G_HM + ζ_HM)    + (1 - φ/φ_c) / (G_m + ζ_HM)    ]^-1 - ζ_HM</span>
                <span class="c1"># where ζ_HM = G_HM/6 * (9 K_HM + 8 G_HM) / (K_HM + 2 G_HM)</span>
                <span class="c1"># Similar for Upper bounds (H) but swapping K_m,G_m with K_HM,G_HM and G_HM with G_m in denominators of terms.</span>
                
                <span class="c1"># Denominators for K_eff_L_dry terms</span>
                <span class="n">den1_Kl</span> <span class="o">=</span> <span class="n">K_HM_dry_critical</span> <span class="o">+</span> <span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">G_HM_dry_critical</span>
                <span class="n">den2_Kl</span> <span class="o">=</span> <span class="n">matrix_bulk_modulus</span> <span class="o">+</span> <span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">G_HM_dry_critical</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den1_Kl</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den2_Kl</span><span class="p">,</span><span class="mf">0.0</span><span class="p">):</span> <span class="n">K_eff_dry_L</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Avoid division by zero if moduli are zero</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">K_eff_dry_L</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">phi_i</span> <span class="o">/</span> <span class="n">phi_critical</span><span class="p">)</span> <span class="o">/</span> <span class="n">den1_Kl</span> <span class="o">+</span> \
                                  <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">phi_i</span> <span class="o">/</span> <span class="n">phi_critical</span><span class="p">)</span> <span class="o">/</span> <span class="n">den2_Kl</span> <span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">G_HM_dry_critical</span>
                
                <span class="n">zeta_L_den</span> <span class="o">=</span> <span class="p">(</span><span class="n">K_HM_dry_critical</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">G_HM_dry_critical</span><span class="p">)</span>
                <span class="n">zeta_L</span> <span class="o">=</span> <span class="p">(</span><span class="n">G_HM_dry_critical</span> <span class="o">/</span> <span class="mf">6.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="n">K_HM_dry_critical</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">G_HM_dry_critical</span><span class="p">)</span> <span class="o">/</span> \
                         <span class="n">zeta_L_den</span> <span class="k">if</span> <span class="n">zeta_L_den</span> <span class="o">!=</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">den1_Gl</span> <span class="o">=</span> <span class="n">G_HM_dry_critical</span> <span class="o">+</span> <span class="n">zeta_L</span>
                <span class="n">den2_Gl</span> <span class="o">=</span> <span class="n">matrix_shear_modulus</span> <span class="o">+</span> <span class="n">zeta_L</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den1_Gl</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den2_Gl</span><span class="p">,</span><span class="mf">0.0</span><span class="p">):</span> <span class="n">G_eff_dry_L</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">G_eff_dry_L</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">phi_i</span> <span class="o">/</span> <span class="n">phi_critical</span><span class="p">)</span> <span class="o">/</span> <span class="n">den1_Gl</span> <span class="o">+</span> \
                                  <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">phi_i</span> <span class="o">/</span> <span class="n">phi_critical</span><span class="p">)</span> <span class="o">/</span> <span class="n">den2_Gl</span> <span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">zeta_L</span>

                <span class="c1"># Denominators for K_eff_H_dry terms</span>
                <span class="n">den1_Kh</span> <span class="o">=</span> <span class="n">K_HM_dry_critical</span> <span class="o">+</span> <span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">matrix_shear_modulus</span> <span class="c1"># Uses G_m here</span>
                <span class="n">den2_Kh</span> <span class="o">=</span> <span class="n">matrix_bulk_modulus</span> <span class="o">+</span> <span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">matrix_shear_modulus</span> <span class="c1"># Uses G_m here</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den1_Kh</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den2_Kh</span><span class="p">,</span><span class="mf">0.0</span><span class="p">):</span> <span class="n">K_eff_dry_H</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">K_eff_dry_H</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">phi_i</span> <span class="o">/</span> <span class="n">phi_critical</span><span class="p">)</span> <span class="o">/</span> <span class="n">den1_Kh</span> <span class="o">+</span> \
                                  <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">phi_i</span> <span class="o">/</span> <span class="n">phi_critical</span><span class="p">)</span> <span class="o">/</span> <span class="n">den2_Kh</span> <span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">matrix_shear_modulus</span>
                
                <span class="n">zeta_H_den</span> <span class="o">=</span> <span class="p">(</span><span class="n">matrix_bulk_modulus</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">matrix_shear_modulus</span><span class="p">)</span>
                <span class="n">zeta_H</span> <span class="o">=</span> <span class="p">(</span><span class="n">matrix_shear_modulus</span> <span class="o">/</span> <span class="mf">6.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="n">matrix_bulk_modulus</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">matrix_shear_modulus</span><span class="p">)</span> <span class="o">/</span> \
                         <span class="n">zeta_H_den</span> <span class="k">if</span> <span class="n">zeta_H_den</span><span class="o">!=</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">den1_Gh</span> <span class="o">=</span> <span class="n">G_HM_dry_critical</span> <span class="o">+</span> <span class="n">zeta_H</span> <span class="c1"># Uses G_HM_dry_crit here</span>
                <span class="n">den2_Gh</span> <span class="o">=</span> <span class="n">matrix_shear_modulus</span> <span class="o">+</span> <span class="n">zeta_H</span> <span class="c1"># Uses G_m here</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den1_Gh</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den2_Gh</span><span class="p">,</span><span class="mf">0.0</span><span class="p">):</span> <span class="n">G_eff_dry_H</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">G_eff_dry_H</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span><span class="n">phi_i</span> <span class="o">/</span> <span class="n">phi_critical</span><span class="p">)</span> <span class="o">/</span> <span class="n">den1_Gh</span> <span class="o">+</span> \
                                  <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">phi_i</span> <span class="o">/</span> <span class="n">phi_critical</span><span class="p">)</span> <span class="o">/</span> <span class="n">den2_Gh</span> <span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">zeta_H</span>
                
                <span class="c1"># Ensure physical non-negative moduli before fluid substitution</span>
                <span class="n">K_eff_dry_L</span><span class="p">,</span> <span class="n">G_eff_dry_L</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">K_eff_dry_L</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">G_eff_dry_L</span><span class="p">)</span>
                <span class="n">K_eff_dry_H</span><span class="p">,</span> <span class="n">G_eff_dry_H</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">K_eff_dry_H</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">G_eff_dry_H</span><span class="p">)</span>

                <span class="c1"># Fluid substitution using Gassmann (via BrieModel&#39;s helper)</span>
                <span class="c1"># K_sat_H from K_eff_H_dry, G_eff_H_dry (Gassmann only changes K, G_sat_dry = G_dry)</span>
                <span class="n">K_sat_H</span> <span class="o">=</span> <span class="n">brie</span><span class="o">.</span><span class="n">calculate_saturated_modulus</span><span class="p">(</span>
                    <span class="n">K_eff_dry_H</span><span class="p">,</span> <span class="n">matrix_bulk_modulus</span><span class="p">,</span> <span class="n">phi_i</span><span class="p">,</span> <span class="n">sat_i</span><span class="p">,</span> <span class="n">water_bulk_modulus</span><span class="p">,</span> <span class="n">gas_bulk_modulus</span>
                <span class="p">)</span>
                <span class="n">G_sat_H</span> <span class="o">=</span> <span class="n">G_eff_dry_H</span> <span class="c1"># Shear modulus unchanged by fluid for Gassmann</span>

                <span class="n">K_sat_L</span> <span class="o">=</span> <span class="n">brie</span><span class="o">.</span><span class="n">calculate_saturated_modulus</span><span class="p">(</span>
                    <span class="n">K_eff_dry_L</span><span class="p">,</span> <span class="n">matrix_bulk_modulus</span><span class="p">,</span> <span class="n">phi_i</span><span class="p">,</span> <span class="n">sat_i</span><span class="p">,</span> <span class="n">water_bulk_modulus</span><span class="p">,</span> <span class="n">gas_bulk_modulus</span>
                <span class="p">)</span>
                <span class="n">G_sat_L</span> <span class="o">=</span> <span class="n">G_eff_dry_L</span> <span class="c1"># Shear modulus unchanged</span>
                
            <span class="k">else</span><span class="p">:</span> <span class="c1"># Porosity &gt;= critical_porosity: Suspension model (Reuss-like average)</span>
                  <span class="c1"># This part models the rock as a suspension of matrix material (properties K_HM, G_HM at phi_c)</span>
                  <span class="c1"># in excess porosity (phi_i - phi_c) filled with fluid.</span>
                  <span class="c1"># The &quot;solid&quot; part of this suspension is the frame at critical porosity.</span>
                  <span class="c1"># The &quot;fluid&quot; part is the content of the excess pores.</span>
                  <span class="c1"># This seems to be a specific variant of Reuss average or similar for high porosity.</span>
                  <span class="c1"># The original code is:</span>
                  <span class="c1"># K_eff = ((1-phi)/(1-phi_c)/(K_HM + 4/3 G_HM) + (phi-phi_c)/(1-phi_c)/(4/3 G_HM))^-1 - 4/3 G_HM</span>
                  <span class="c1"># This looks like Reuss average for K_dry where one component is frame at phi_c,</span>
                  <span class="c1"># and other component is &quot;empty pores&quot; with K=0, G=G_HM (this G for empty pores is unusual).</span>
                  <span class="c1"># Typically for Reuss with empty pores (K_pore=0, G_pore=0):</span>
                  <span class="c1"># 1/K_dry = (1-phi_excess)/K_frame_at_phic + phi_excess/K_pore -&gt; K_dry = K_frame_at_phic * (1-phi_excess)</span>
                  <span class="c1"># 1/G_dry = (1-phi_excess)/G_frame_at_phic + phi_excess/G_pore -&gt; G_dry = G_frame_at_phic * (1-phi_excess)</span>
                  <span class="c1"># Where phi_excess = (phi_i - phi_c) / (1 - phi_c) is porosity relative to non-solid volume.</span>
                  <span class="c1"># The original code seems to use a specific variant. We will follow it.</span>
                
                <span class="c1"># Effective moduli of the dry frame for phi &gt;= phi_c</span>
                <span class="c1"># Fraction of original solid phase (at critical porosity) in the (1-phi_c) volume</span>
                <span class="n">frac_solid_phase</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">phi_i</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">phi_critical</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">phi_critical</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="c1"># Fraction of &quot;added&quot; pore space (beyond critical) in the (1-phi_c) volume</span>
                <span class="n">frac_added_pores</span> <span class="o">=</span> <span class="p">(</span><span class="n">phi_i</span> <span class="o">-</span> <span class="n">phi_critical</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">phi_critical</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">phi_critical</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1.0</span>
                
                <span class="c1"># Ensure fractions are valid (e.g. phi_i should not be &lt; phi_critical here if logic is strict)</span>
                <span class="c1"># However, original code structure implies phi_i &gt;= phi_c for this branch.</span>
                <span class="c1"># If phi_i = phi_critical, then frac_solid_phase=1, frac_added_pores=0. K_eff should be K_HM.</span>

                <span class="c1"># Denominators for K_eff_susp_dry terms</span>
                <span class="n">den1_Keff_susp</span> <span class="o">=</span> <span class="n">K_HM_dry_critical</span> <span class="o">+</span> <span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">G_HM_dry_critical</span>
                <span class="n">den2_Keff_susp</span> <span class="o">=</span> <span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">G_HM_dry_critical</span> <span class="c1"># This term for K is unusual (fluid K=0 usually)</span>
                
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den1_Keff_susp</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den2_Keff_susp</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">phi_critical</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">):</span>
                    <span class="n">K_eff_susp_dry</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># Or K_HM_dry_critical if phi_i approx phi_c</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">phi_i</span><span class="p">,</span> <span class="n">phi_critical</span><span class="p">):</span> <span class="n">K_eff_susp_dry</span> <span class="o">=</span> <span class="n">K_HM_dry_critical</span>
                <span class="k">else</span><span class="p">:</span>
                     <span class="n">K_eff_susp_dry</span> <span class="o">=</span> <span class="p">(</span> <span class="n">frac_solid_phase</span> <span class="o">/</span> <span class="n">den1_Keff_susp</span> <span class="o">+</span> <span class="n">frac_added_pores</span> <span class="o">/</span> <span class="n">den2_Keff_susp</span> 
                                       <span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">G_HM_dry_critical</span>
                
                <span class="n">zeta_susp_den</span> <span class="o">=</span> <span class="p">(</span><span class="n">K_HM_dry_critical</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">G_HM_dry_critical</span><span class="p">)</span>
                <span class="n">zeta_susp</span> <span class="o">=</span> <span class="p">(</span><span class="n">G_HM_dry_critical</span> <span class="o">/</span> <span class="mf">6.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="n">K_HM_dry_critical</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">G_HM_dry_critical</span><span class="p">)</span> <span class="o">/</span> \
                            <span class="n">zeta_susp_den</span> <span class="k">if</span> <span class="n">zeta_susp_den</span> <span class="o">!=</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
                <span class="n">den1_Geff_susp</span> <span class="o">=</span> <span class="n">G_HM_dry_critical</span> <span class="o">+</span> <span class="n">zeta_susp</span>
                <span class="n">den2_Geff_susp</span> <span class="o">=</span> <span class="n">zeta_susp</span> <span class="c1"># Term for &quot;added pores&quot; G=0 contribution</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den1_Geff_susp</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den2_Geff_susp</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">phi_critical</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">):</span>
                    <span class="n">G_eff_susp_dry</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">phi_i</span><span class="p">,</span> <span class="n">phi_critical</span><span class="p">):</span> <span class="n">G_eff_susp_dry</span> <span class="o">=</span> <span class="n">G_HM_dry_critical</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">G_eff_susp_dry</span> <span class="o">=</span> <span class="p">(</span> <span class="n">frac_solid_phase</span> <span class="o">/</span> <span class="n">den1_Geff_susp</span> <span class="o">+</span> <span class="n">frac_added_pores</span> <span class="o">/</span> <span class="n">den2_Geff_susp</span>
                                       <span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">zeta_susp</span>
                
                <span class="n">K_eff_susp_dry</span><span class="p">,</span> <span class="n">G_eff_susp_dry</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">K_eff_susp_dry</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">G_eff_susp_dry</span><span class="p">)</span>

                <span class="c1"># Fluid substitution for this suspension-like dry frame</span>
                <span class="c1"># Both high and low bounds become equal in this regime as per original code.</span>
                <span class="n">K_sat_H</span> <span class="o">=</span> <span class="n">K_sat_L</span> <span class="o">=</span> <span class="n">brie</span><span class="o">.</span><span class="n">calculate_saturated_modulus</span><span class="p">(</span>
                    <span class="n">K_eff_susp_dry</span><span class="p">,</span> <span class="n">matrix_bulk_modulus</span><span class="p">,</span> <span class="n">phi_i</span><span class="p">,</span> <span class="n">sat_i</span><span class="p">,</span> <span class="n">water_bulk_modulus</span><span class="p">,</span> <span class="n">gas_bulk_modulus</span>
                <span class="p">)</span>
                <span class="n">G_sat_H</span> <span class="o">=</span> <span class="n">G_sat_L</span> <span class="o">=</span> <span class="n">G_eff_susp_dry</span> <span class="c1"># Shear modulus unchanged by fluid</span>
            
            <span class="c1"># Calculate total effective density (ρ_total_eff)</span>
            <span class="n">rho_fluid_eff</span> <span class="o">=</span> <span class="n">sat_i</span> <span class="o">*</span> <span class="n">water_density</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">sat_i</span><span class="p">)</span> <span class="o">*</span> <span class="n">gas_density</span>
            <span class="n">rho_total_eff</span> <span class="o">=</span> <span class="n">matrix_density</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">phi_i</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho_fluid_eff</span> <span class="o">*</span> <span class="n">phi_i</span>
            <span class="k">if</span> <span class="n">rho_total_eff</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># This might happen if matrix_density is low and porosity is high with light gas.</span>
                <span class="c1"># Or if phi_i &gt; 1 or sat_i is outside [0,1].</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Total effective density is non-positive (</span><span class="si">{</span><span class="n">rho_total_eff</span><span class="si">}</span><span class="s2"> kg/m³) at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. Vp will be NaN.&quot;</span><span class="p">)</span>
                <span class="n">Vp_high_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">Vp_low_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">continue</span>


            <span class="c1"># Calculate P-wave velocities for high and low bounds</span>
            <span class="c1"># Vp = sqrt((K_sat + 4/3*G_sat) / ρ_total_eff)</span>
            <span class="c1"># Moduli are in GPa, convert to Pa (multiply by 1e9)</span>
            <span class="n">p_wave_modulus_H</span> <span class="o">=</span> <span class="n">K_sat_H</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="o">+</span> <span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">G_sat_H</span> <span class="o">*</span> <span class="mf">1e9</span>
            <span class="n">p_wave_modulus_L</span> <span class="o">=</span> <span class="n">K_sat_L</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="o">+</span> <span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">G_sat_L</span> <span class="o">*</span> <span class="mf">1e9</span>

            <span class="k">if</span> <span class="n">p_wave_modulus_H</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">Vp_high_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">Vp_high_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_wave_modulus_H</span> <span class="o">/</span> <span class="n">rho_total_eff</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">p_wave_modulus_L</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">Vp_low_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">Vp_low_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_wave_modulus_L</span> <span class="o">/</span> <span class="n">rho_total_eff</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">Vp_high_results</span><span class="p">,</span> <span class="n">Vp_low_results</span></div></div>


<span class="c1"># Standalone functions (potentially older versions or specific use cases)</span>
<span class="c1"># These are kept but should be reviewed for consistency with the class-based models above.</span>
<span class="c1"># Their documentation will also be improved.</span>

<div class="viewcode-block" id="VRH_model"><a class="viewcode-back" href="../../../api/petrophysics.html#PyHydroGeophysX.VRH_model">[docs]</a><span class="k">def</span> <span class="nf">VRH_model</span><span class="p">(</span><span class="n">f</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.125</span><span class="p">,</span> <span class="mf">0.075</span><span class="p">],</span> <span class="c1"># Default values are illustrative</span>
             <span class="n">K_minerals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mf">55.4</span><span class="p">,</span> <span class="mf">36.6</span><span class="p">,</span> <span class="mf">75.6</span><span class="p">,</span> <span class="mf">46.7</span><span class="p">,</span> <span class="mf">50.4</span><span class="p">],</span> <span class="c1"># K for each mineral</span>
             <span class="n">G_minerals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mf">28.1</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mf">25.6</span><span class="p">,</span> <span class="mf">23.65</span><span class="p">,</span> <span class="mf">27.4</span><span class="p">],</span>   <span class="c1"># G for each mineral</span>
             <span class="n">rho_minerals</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">2560</span><span class="p">,</span> <span class="mi">2650</span><span class="p">,</span> <span class="mi">2630</span><span class="p">,</span> <span class="mi">2540</span><span class="p">,</span> <span class="mi">3050</span><span class="p">]</span> <span class="c1"># ρ for each mineral</span>
             <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Standalone function implementing the Voigt-Reuss-Hill (VRH) mixing model.</span>

<span class="sd">    Estimates effective bulk modulus (K_eff), shear modulus (G_eff), and density (rho_eff)</span>
<span class="sd">    of a composite material (rock matrix) made from various mineral components.</span>
<span class="sd">    This function is similar to `VRHModel.calculate_properties`.</span>

<span class="sd">    Args:</span>
<span class="sd">        f (List[float], optional): List of volume fractions of each mineral component.</span>
<span class="sd">                                   Must sum to 1.0. Defaults are illustrative.</span>
<span class="sd">        K_minerals (List[float], optional): List of bulk moduli (K) for each mineral [GPa].</span>
<span class="sd">        G_minerals (List[float], optional): List of shear moduli (G) for each mineral [GPa].</span>
<span class="sd">        rho_minerals (List[float], optional): List of densities (ρ) for each mineral [kg/m³].</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[float, float, float]:</span>
<span class="sd">            - K_eff (float): Effective bulk modulus of the mineral mixture [GPa].</span>
<span class="sd">            - G_eff (float): Effective shear modulus of the mineral mixture [GPa].</span>
<span class="sd">            - rho_eff (float): Effective density of the mineral mixture [kg/m³].</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If input lists have different lengths or if fractions do not sum to 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">K_minerals</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">G_minerals</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">rho_minerals</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All input lists (fractions, K, G, rho) must have the same length.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input lists cannot be empty.&quot;</span><span class="p">)</span>

    <span class="n">f_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">K_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">K_minerals</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">G_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">G_minerals</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">rho_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rho_minerals</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f_arr</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Volume fractions must sum to 1.0. Current sum: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f_arr</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">K_arr</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">G_arr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span> <span class="c1"># G can be 0 for fluids, but typically minerals have G&gt;0</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Mineral bulk moduli must be positive, and shear moduli non-negative.&quot;</span><span class="p">)</span>


    <span class="c1"># Voigt average (upper bound for moduli)</span>
    <span class="n">K_voigt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f_arr</span> <span class="o">*</span> <span class="n">K_arr</span><span class="p">)</span>
    <span class="n">G_voigt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f_arr</span> <span class="o">*</span> <span class="n">G_arr</span><span class="p">)</span>

    <span class="c1"># Reuss average (lower bound for moduli)</span>
    <span class="c1"># Handle potential division by zero if any K_i or G_i is zero.</span>
    <span class="c1"># For G_reuss, if any G_i is zero (fluid component), G_reuss becomes 0.</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span> <span class="c1"># Suppress warning for division by zero</span>
        <span class="n">sum_f_over_K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f_arr</span> <span class="o">/</span> <span class="n">K_arr</span><span class="p">)</span>
        <span class="n">sum_f_over_G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f_arr</span> <span class="o">/</span> <span class="n">G_arr</span><span class="p">)</span> <span class="c1"># Can be inf if any G_i is 0</span>

    <span class="n">K_reuss</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">sum_f_over_K</span> <span class="k">if</span> <span class="n">sum_f_over_K</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="c1"># Or 0 if K is stiffness? This is compliance sum.</span>
                                                              <span class="c1"># If sum_f_over_K is 0 (all K_i are inf), K_reuss is inf.</span>
                                                              <span class="c1"># If any K_i is 0, sum_f_over_K is inf, K_reuss is 0.</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">sum_f_over_G</span><span class="p">):</span> <span class="c1"># If any component is fluid (G_i=0, f_i&gt;0)</span>
        <span class="n">G_reuss</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">elif</span> <span class="n">sum_f_over_G</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Should not happen if sum(f)=1 and G_i are finite.</span>
        <span class="n">G_reuss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="n">G_reuss</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">sum_f_over_G</span>
    
    <span class="c1"># VRH average is the arithmetic mean of Voigt and Reuss bounds</span>
    <span class="n">K_eff</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">K_voigt</span> <span class="o">+</span> <span class="n">K_reuss</span><span class="p">)</span>
    <span class="n">G_eff</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">G_voigt</span> <span class="o">+</span> <span class="n">G_reuss</span><span class="p">)</span>

    <span class="c1"># Effective density is the weighted sum of component densities</span>
    <span class="n">rho_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f_arr</span> <span class="o">*</span> <span class="n">rho_arr</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">K_eff</span><span class="p">,</span> <span class="n">G_eff</span><span class="p">,</span> <span class="n">rho_eff</span></div>


<div class="viewcode-block" id="satK"><a class="viewcode-back" href="../../../api/petrophysics.html#PyHydroGeophysX.satK">[docs]</a><span class="k">def</span> <span class="nf">satK</span><span class="p">(</span><span class="n">K_dry_rock</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">K_matrix</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">porosity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">saturation_water</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
         <span class="n">water_bulk_modulus</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.2</span><span class="p">,</span> <span class="n">gas_bulk_modulus</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">brie_exponent</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Standalone function to calculate saturated bulk modulus (K_sat) using Gassmann&#39;s equation,</span>
<span class="sd">    with effective fluid modulus from Brie&#39;s model.</span>
<span class="sd">    Similar to `BrieModel.calculate_saturated_modulus`.</span>

<span class="sd">    Args:</span>
<span class="sd">        K_dry_rock (float): Effective bulk modulus of the dry rock frame (K_eff_dry) [GPa].</span>
<span class="sd">        K_matrix (float): Bulk modulus of the solid mineral matrix (Km) [GPa].</span>
<span class="sd">        porosity (float): Porosity of the rock (phi).</span>
<span class="sd">        saturation_water (float): Water saturation level (Sat).</span>
<span class="sd">        water_bulk_modulus (float, optional): Bulk modulus of water (Kw) [GPa]. Defaults to 2.2.</span>
<span class="sd">        gas_bulk_modulus (float, optional): Bulk modulus of gas (Ka) [GPa]. Defaults to 0.01.</span>
<span class="sd">        brie_exponent (float, optional): Exponent for Brie&#39;s fluid mixing model. Defaults to 3.0.</span>

<span class="sd">    Returns:</span>
<span class="sd">        float: Saturated bulk modulus (K_sat) [GPa].</span>
<span class="sd">    </span>
<span class="sd">    Raises:</span>
<span class="sd">        ValueError for non-physical inputs.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">porosity</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Porosity must be between 0 and 1.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">saturation_water</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Saturation must be between 0 and 1.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">K_dry_rock</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">K_matrix</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">water_bulk_modulus</span> <span class="o">&lt;=</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">gas_bulk_modulus</span> <span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Bulk moduli must be positive (K_matrix, K_water, K_gas &gt; 0; K_dry_rock &gt;=0).&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">K_dry_rock</span> <span class="o">&gt;</span> <span class="n">K_matrix</span><span class="p">:</span> <span class="c1"># Check physical constraint for Gassmann</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Dry rock bulk modulus (</span><span class="si">{</span><span class="n">K_dry_rock</span><span class="si">}</span><span class="s2">) &gt; matrix bulk modulus (</span><span class="si">{</span><span class="n">K_matrix</span><span class="si">}</span><span class="s2">). This is unusual.&quot;</span><span class="p">)</span>

    <span class="c1"># Effective fluid bulk modulus using Brie&#39;s equation</span>
    <span class="n">K_fluid_eff</span> <span class="o">=</span> <span class="p">(</span><span class="n">water_bulk_modulus</span> <span class="o">-</span> <span class="n">gas_bulk_modulus</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">saturation_water</span> <span class="o">**</span> <span class="n">brie_exponent</span><span class="p">)</span> <span class="o">+</span> <span class="n">gas_bulk_modulus</span>
    <span class="k">if</span> <span class="n">K_fluid_eff</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculated effective fluid modulus is non-positive (</span><span class="si">{</span><span class="n">K_fluid_eff</span><span class="si">}</span><span class="s2"> GPa).&quot;</span><span class="p">)</span>

    <span class="c1"># Gassmann&#39;s equation - standard form: K_sat = K_dry + num/den</span>
    <span class="c1"># num = (1 - K_dry/K_matrix)^2</span>
    <span class="c1"># den = porosity/K_fluid_eff + (1-porosity)/K_matrix - K_dry/(K_matrix^2)</span>
    <span class="c1"># The form used in original code:</span>
    <span class="c1"># K_sat = (K_dry_rock / (K_matrix - K_dry_rock) + K_fluid_eff / (porosity * (K_matrix - K_fluid_eff))) * K_matrix / \</span>
    <span class="c1">#         (1 + (K_dry_rock / (K_matrix - K_dry_rock) + K_fluid_eff / (porosity * (K_matrix - K_fluid_eff))))</span>
    <span class="c1"># This form has potential divisions by zero if K_matrix == K_dry_rock or K_matrix == K_fluid_eff.</span>
    <span class="c1"># Let&#39;s use the more robust standard Gassmann formulation to avoid some pitfalls.</span>
    
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">K_matrix</span><span class="p">,</span> <span class="n">K_dry_rock</span><span class="p">):</span> <span class="c1"># If K_dry is same as K_matrix (e.g. zero porosity limit)</span>
        <span class="k">return</span> <span class="n">K_matrix</span> <span class="c1"># K_sat should be K_matrix</span>

    <span class="n">term_Kdry_over_Kmatrix</span> <span class="o">=</span> <span class="n">K_dry_rock</span> <span class="o">/</span> <span class="n">K_matrix</span>
    <span class="n">numerator_gassmann</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">term_Kdry_over_Kmatrix</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    
    <span class="c1"># Denominator terms - check for division by zero</span>
    <span class="n">term_phi_over_Kfluid</span> <span class="o">=</span> <span class="n">porosity</span> <span class="o">/</span> <span class="n">K_fluid_eff</span> <span class="k">if</span> <span class="n">K_fluid_eff</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">term_1minphi_over_Kmatrix</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">porosity</span><span class="p">)</span> <span class="o">/</span> <span class="n">K_matrix</span> <span class="k">if</span> <span class="n">K_matrix</span> <span class="o">!=</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">term_Kdry_over_KmatrixSq</span> <span class="o">=</span> <span class="n">K_dry_rock</span> <span class="o">/</span> <span class="p">(</span><span class="n">K_matrix</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">K_matrix</span> <span class="o">!=</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span> <span class="c1"># if K_matrix is 0, K_dry should also be 0</span>
    
    <span class="n">denominator_gassmann</span> <span class="o">=</span> <span class="n">term_phi_over_Kfluid</span> <span class="o">+</span> <span class="n">term_1minphi_over_Kmatrix</span> <span class="o">-</span> <span class="n">term_Kdry_over_KmatrixSq</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">denominator_gassmann</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">denominator_gassmann</span><span class="p">):</span>
        <span class="c1"># If denominator is zero or infinite, it means K_sat might be K_dry (if num is also zero) or K_matrix.</span>
        <span class="c1"># This often happens if K_fluid_eff is very small (gas), K_sat should approach K_dry.</span>
        <span class="c1"># If K_fluid_eff is very large (stiff fluid), K_sat approaches K_matrix (upper bound).</span>
        <span class="c1"># A simple fallback if K_fluid_eff is very small relative to K_dry and K_matrix:</span>
        <span class="k">if</span> <span class="n">K_fluid_eff</span> <span class="o">&lt;</span> <span class="mf">0.001</span> <span class="o">*</span> <span class="n">K_dry_rock</span> <span class="p">:</span> <span class="c1"># Heuristic for gas-like fluid</span>
            <span class="k">return</span> <span class="n">K_dry_rock</span> <span class="c1"># For gas saturation, K_sat is close to K_dry</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Otherwise, implies K_sat is likely K_matrix or problem with inputs</span>
            <span class="c1"># This situation means the rock is incompressible by the fluid.</span>
            <span class="c1"># print(f&quot;Warning: Gassmann denominator near zero/inf for K_dry={K_dry_rock}, K_m={K_matrix}, phi={porosity}, K_fl={K_fluid_eff}. Returning K_matrix.&quot;)</span>
            <span class="k">return</span> <span class="n">K_matrix</span> <span class="c1"># Limit where fluid is much stiffer or frame very compliant</span>
            
    <span class="n">K_saturated</span> <span class="o">=</span> <span class="n">K_dry_rock</span> <span class="o">+</span> <span class="n">numerator_gassmann</span> <span class="o">/</span> <span class="n">denominator_gassmann</span>
    <span class="k">return</span> <span class="n">K_saturated</span></div>


<div class="viewcode-block" id="velDEM"><a class="viewcode-back" href="../../../api/petrophysics.html#PyHydroGeophysX.velDEM">[docs]</a><span class="k">def</span> <span class="nf">velDEM</span><span class="p">(</span><span class="n">phi_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">K_matrix_init</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">G_matrix_init</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">rho_matrix</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
           <span class="n">saturation_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">aspect_ratio_pores</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
           <span class="n">water_bulk_modulus</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.2</span><span class="p">,</span> <span class="n">gas_bulk_modulus</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
           <span class="n">water_density</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="n">gas_density</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.225</span>
           <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Standalone function to calculate effective moduli (K_eff, G_eff) and P-wave velocity (Vp)</span>
<span class="sd">    using a Differential Effective Medium (DEM) model.</span>
<span class="sd">    Similar to `DEMModel.calculate_velocity`.</span>

<span class="sd">    Args:</span>
<span class="sd">        phi_array (np.ndarray): Array of porosity values (φ).</span>
<span class="sd">        K_matrix_init (float): Initial bulk modulus of the solid matrix (Km) [GPa].</span>
<span class="sd">        G_matrix_init (float): Initial shear modulus of the solid matrix (Gm) [GPa].</span>
<span class="sd">        rho_matrix (float): Density of the solid matrix (ρ_b) [kg/m³].</span>
<span class="sd">        saturation_array (np.ndarray): Array of water saturation values (Sat). Must match `phi_array` shape.</span>
<span class="sd">        aspect_ratio_pores (float): Aspect ratio of pores/cracks (alpha).</span>
<span class="sd">        water_bulk_modulus (float, optional): Bulk modulus of water (Kw) [GPa]. Defaults to 2.2.</span>
<span class="sd">        gas_bulk_modulus (float, optional): Bulk modulus of gas (Ka) [GPa]. Defaults to 0.01.</span>
<span class="sd">        water_density (float, optional): Density of water [kg/m³]. Defaults to 1000.0.</span>
<span class="sd">        gas_density (float, optional): Density of gas [kg/m³]. Defaults to 1.225.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[np.ndarray, np.ndarray, np.ndarray]:</span>
<span class="sd">            - K_eff_results (np.ndarray): Effective bulk modulus for each porosity [GPa].</span>
<span class="sd">            - G_eff_results (np.ndarray): Effective shear modulus for each porosity [GPa].</span>
<span class="sd">            - Vp_results (np.ndarray): P-wave velocity for each porosity [m/s].</span>
<span class="sd">            </span>
<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If root finding fails or inputs are inconsistent/non-physical.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">phi_array</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">saturation_array</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Porosity and saturation arrays must have the same shape.&quot;</span><span class="p">)</span>

    <span class="n">num_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phi_array</span><span class="p">)</span>
    <span class="n">K_eff_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_points</span><span class="p">)</span>
    <span class="n">G_eff_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_points</span><span class="p">)</span>
    <span class="n">Vp_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_points</span><span class="p">)</span>

    <span class="c1"># Brie model for effective fluid properties (using a default exponent of 3.0 from BrieModel class)</span>
    <span class="n">brie_fluid_model</span> <span class="o">=</span> <span class="n">BrieModel</span><span class="p">()</span> 

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_points</span><span class="p">):</span>
        <span class="n">current_phi</span> <span class="o">=</span> <span class="n">phi_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">current_sat</span> <span class="o">=</span> <span class="n">saturation_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">current_phi</span> <span class="o">&lt;=</span> <span class="mf">1.0</span> <span class="ow">and</span> <span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">current_sat</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Invalid porosity (</span><span class="si">{</span><span class="n">current_phi</span><span class="si">}</span><span class="s2">) or saturation (</span><span class="si">{</span><span class="n">current_sat</span><span class="si">}</span><span class="s2">) at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. Skipping calculation for this point (NaN results).&quot;</span><span class="p">)</span>
            <span class="n">K_eff_results</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">G_eff_results</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">Vp_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">continue</span>

        <span class="c1"># Effective fluid bulk modulus (Kf) using Brie&#39;s model</span>
        <span class="n">K_fluid_effective</span> <span class="o">=</span> <span class="n">brie_fluid_model</span><span class="o">.</span><span class="n">calculate_fluid_modulus</span><span class="p">(</span><span class="n">current_sat</span><span class="p">,</span> <span class="n">water_bulk_modulus</span><span class="p">,</span> <span class="n">gas_bulk_modulus</span><span class="p">)</span>
        
        <span class="c1"># Poisson&#39;s ratio of the initial solid matrix material</span>
        <span class="n">v_matrix</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">K_matrix_init</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">G_matrix_init</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">K_matrix_init</span> <span class="o">+</span> <span class="n">G_matrix_init</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">&lt;</span> <span class="n">v_matrix</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">):</span>
             <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Matrix Poisson&#39;s ratio (</span><span class="si">{</span><span class="n">v_matrix</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">) for initial matrix is outside physical bounds.&quot;</span><span class="p">)</span>


        <span class="c1"># DEM parameters (b, c, d, g) based on initial matrix properties and pore aspect ratio</span>
        <span class="n">b_param</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">aspect_ratio_pores</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v_matrix</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">v_matrix</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        
        <span class="c1"># Original two-step definition of c and d: c_val = 1 / (1/5 * term_c); d_val = 1 / (1/5 * term_d)</span>
        <span class="c1"># Equivalent to c_val = 5 / term_c</span>
        <span class="n">term_c_inv</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">v_matrix</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">aspect_ratio_pores</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">v_matrix</span><span class="p">)))</span>
        <span class="n">c_param</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="o">/</span> <span class="n">term_c_inv</span> <span class="k">if</span> <span class="n">term_c_inv</span> <span class="o">!=</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="c1"># Original was 1/(0.2*term) then 1/c_param</span>
                                                                <span class="c1"># This seems to be c_param = 0.2 * term_c_inv, then c = 1/c.</span>
                                                                <span class="c1"># The formulation in DEMModel class was used: c = 1.0 / (0.2 * c_inv_term)</span>
                                                                <span class="c1"># Let&#39;s match DEMModel class for consistency.</span>
        <span class="n">c_param</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">term_c_inv</span><span class="p">)</span> <span class="k">if</span> <span class="n">term_c_inv</span> <span class="o">!=</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

        <span class="n">term_d_inv</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">v_matrix</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">5</span> <span class="o">-</span> <span class="n">v_matrix</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">aspect_ratio_pores</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">v_matrix</span><span class="p">)))</span>
        <span class="n">d_param</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">term_d_inv</span><span class="p">)</span> <span class="k">if</span> <span class="n">term_d_inv</span> <span class="o">!=</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        
        <span class="n">g_param</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">aspect_ratio_pores</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">v_matrix</span><span class="p">))</span>
        
        <span class="c1"># Implicit equation for K_eff (same as in DEMModel class)</span>
        <span class="k">def</span> <span class="nf">eq_Keff_dem</span><span class="p">(</span><span class="n">Keff_try</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">Keff_try</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="mf">1e12</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">K_matrix_init</span><span class="p">,</span> <span class="n">K_fluid_effective</span><span class="p">):</span> <span class="k">return</span> <span class="n">Keff_try</span> <span class="o">-</span> <span class="n">K_matrix_init</span>
            <span class="n">lhs_k</span> <span class="o">=</span> <span class="p">(</span><span class="n">Keff_try</span> <span class="o">-</span> <span class="n">K_fluid_effective</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">K_matrix_init</span> <span class="o">-</span> <span class="n">K_fluid_effective</span><span class="p">)</span> <span class="o">*</span> \
                    <span class="p">(</span><span class="n">K_matrix_init</span> <span class="o">/</span> <span class="n">Keff_try</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">b_param</span><span class="p">))</span>
            <span class="n">rhs_k</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">current_phi</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">b_param</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">lhs_k</span> <span class="o">-</span> <span class="n">rhs_k</span>

        <span class="n">sol_K</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="n">eq_Keff_dem</span><span class="p">,</span> <span class="n">K_matrix_init</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;lm&#39;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sol_K</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="n">sol_K</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">K_eff_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_K</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;velDEM: K_eff root finding failed (index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, phi=</span><span class="si">{</span><span class="n">current_phi</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, sat=</span><span class="si">{</span><span class="n">current_sat</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">sol_K</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="c1"># Implicit equation for G_eff (same as in DEMModel class)</span>
        <span class="c1"># Ensure K_fluid_effective is not zero for safety in c*g/(d*Kf) term</span>
        <span class="n">k_fluid_safe</span> <span class="o">=</span> <span class="n">K_fluid_effective</span> <span class="k">if</span> <span class="n">K_fluid_effective</span> <span class="o">&gt;</span> <span class="mf">1e-9</span> <span class="k">else</span> <span class="mf">1e-9</span>
        <span class="k">def</span> <span class="nf">eq_Geff_dem</span><span class="p">(</span><span class="n">Geff_try</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">Geff_try</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="mf">1e12</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">G_matrix_init</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">):</span> <span class="k">return</span> <span class="n">Geff_try</span> <span class="c1"># if matrix G is 0, effective G should be 0.</span>
            
            <span class="n">term_num_g</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">Geff_try</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">c_param</span> <span class="o">*</span> <span class="n">g_param</span> <span class="o">/</span> <span class="p">(</span><span class="n">d_param</span> <span class="o">*</span> <span class="n">k_fluid_safe</span><span class="p">))</span>
            <span class="n">term_den_g</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">G_matrix_init</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">c_param</span> <span class="o">*</span> <span class="n">g_param</span> <span class="o">/</span> <span class="p">(</span><span class="n">d_param</span> <span class="o">*</span> <span class="n">k_fluid_safe</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">term_den_g</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">):</span> <span class="k">return</span> <span class="mf">1e12</span> <span class="c1"># Avoid division by zero</span>
            
            <span class="n">ratio_g</span> <span class="o">=</span> <span class="n">term_num_g</span> <span class="o">/</span> <span class="n">term_den_g</span>
            <span class="n">exp_g</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="n">c_param</span> <span class="o">/</span> <span class="n">d_param</span><span class="p">)</span> <span class="k">if</span> <span class="n">d_param</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1.0</span>
            <span class="k">if</span> <span class="n">ratio_g</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exp_g</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">exp_g</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span> <span class="k">return</span> <span class="mf">1e12</span> <span class="c1"># Avoid complex numbers</span>

            <span class="n">lhs_g</span> <span class="o">=</span> <span class="p">(</span><span class="n">Geff_try</span> <span class="o">/</span> <span class="n">G_matrix_init</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ratio_g</span> <span class="o">**</span> <span class="n">exp_g</span><span class="p">)</span>
            <span class="n">rhs_g</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">current_phi</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">d_param</span> <span class="k">if</span> <span class="n">d_param</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">lhs_g</span> <span class="o">-</span> <span class="n">rhs_g</span>

        <span class="n">sol_G</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="n">eq_Geff_dem</span><span class="p">,</span> <span class="n">G_matrix_init</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;lm&#39;</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sol_G</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="n">sol_G</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">G_eff_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sol_G</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;velDEM: G_eff root finding failed (index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, phi=</span><span class="si">{</span><span class="n">current_phi</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, sat=</span><span class="si">{</span><span class="n">current_sat</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">sol_G</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Total density</span>
        <span class="n">rho_fluid_effective</span> <span class="o">=</span> <span class="n">current_sat</span> <span class="o">*</span> <span class="n">water_density</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">current_sat</span><span class="p">)</span> <span class="o">*</span> <span class="n">gas_density</span>
        <span class="n">rho_total_effective</span> <span class="o">=</span> <span class="n">rho_matrix</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">current_phi</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho_fluid_effective</span> <span class="o">*</span> <span class="n">current_phi</span>
        <span class="k">if</span> <span class="n">rho_total_effective</span> <span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;velDEM: Total density non-positive (</span><span class="si">{</span><span class="n">rho_total_effective</span><span class="si">}</span><span class="s2">) at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># P-wave velocity (moduli in GPa converted to Pa)</span>
        <span class="n">p_modulus</span> <span class="o">=</span> <span class="n">K_eff_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="o">+</span> <span class="p">(</span><span class="mf">4.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">G_eff_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span>
        <span class="k">if</span> <span class="n">p_modulus</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
             <span class="n">Vp_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="c1"># Non-physical modulus</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Vp_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_modulus</span> <span class="o">/</span> <span class="n">rho_total_effective</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">K_eff_results</span><span class="p">,</span> <span class="n">G_eff_results</span><span class="p">,</span> <span class="n">Vp_results</span></div>


<div class="viewcode-block" id="vel_porous"><a class="viewcode-back" href="../../../api/petrophysics.html#PyHydroGeophysX.vel_porous">[docs]</a><span class="k">def</span> <span class="nf">vel_porous</span><span class="p">(</span><span class="n">phi_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">K_matrix</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">G_matrix</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">rho_matrix</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
               <span class="n">saturation_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
               <span class="n">critical_porosity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">coordination_number</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">4.0</span><span class="p">,</span>
               <span class="n">water_bulk_modulus</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.2</span><span class="p">,</span> <span class="n">gas_bulk_modulus</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
               <span class="n">water_density</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="n">gas_density</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.225</span>
               <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Standalone function to calculate P-wave velocity bounds (Vp_high, Vp_low) for porous rocks.</span>
<span class="sd">    Combines Hertz-Mindlin theory for critical porosity frame moduli with Hashin-Shtrikman bounds</span>
<span class="sd">    and fluid substitution (via Brie&#39;s model / `satK` helper).</span>
<span class="sd">    Similar to `HertzMindlinModel.calculate_velocity`.</span>

<span class="sd">    Args:</span>
<span class="sd">        phi_array (np.ndarray): Array of porosity values (φ).</span>
<span class="sd">        K_matrix (float): Bulk modulus of the solid mineral matrix (Km) [GPa].</span>
<span class="sd">        G_matrix (float): Shear modulus of the solid mineral matrix (Gm) [GPa].</span>
<span class="sd">        rho_matrix (float): Density of the solid matrix (ρ_b) [kg/m³].</span>
<span class="sd">        saturation_array (np.ndarray): Array of water saturation values (Sat).</span>
<span class="sd">        depth (float, optional): Depth for effective pressure estimation [m]. Defaults to 1.0.</span>
<span class="sd">        critical_porosity (float, optional): Critical porosity (φ_c). Defaults to 0.4.</span>
<span class="sd">        coordination_number (float, optional): Avg. grain contacts (C) at φ_c. Defaults to 4.0.</span>
<span class="sd">                                               (Note: 4 is low for typical sphere packs, 6-9 is more common).</span>
<span class="sd">        water_bulk_modulus (float, optional): K_water [GPa]. Defaults to 2.2.</span>
<span class="sd">        gas_bulk_modulus (float, optional): K_gas [GPa]. Defaults to 0.01.</span>
<span class="sd">        water_density (float, optional): ρ_water [kg/m³]. Defaults to 1000.0.</span>
<span class="sd">        gas_density (float, optional): ρ_gas [kg/m³]. Defaults to 1.225.</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">        Tuple[np.ndarray, np.ndarray]:</span>
<span class="sd">            - Vp_high (np.ndarray): P-wave velocity upper bound [m/s].</span>
<span class="sd">            - Vp_low (np.ndarray): P-wave velocity lower bound [m/s].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">phi_array</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">saturation_array</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Porosity and saturation arrays must have the same shape.&quot;</span><span class="p">)</span>

    <span class="c1"># Poisson&#39;s ratio of the solid matrix</span>
    <span class="n">v_matrix</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">K_matrix</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">G_matrix</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">K_matrix</span> <span class="o">+</span> <span class="n">G_matrix</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">&lt;</span> <span class="n">v_matrix</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">):</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Matrix Poisson&#39;s ratio (</span><span class="si">{</span><span class="n">v_matrix</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">) is outside physical bounds.&quot;</span><span class="p">)</span>

    <span class="c1"># Simplified effective pressure calculation [GPa]</span>
    <span class="c1"># Potential Issue: (rho_matrix - 1000) can be negative if rho_matrix &lt; 1000.</span>
    <span class="c1"># Pressure P should be non-negative for Hertz-Mindlin.</span>
    <span class="n">P_eff_gpa</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">rho_matrix</span> <span class="o">-</span> <span class="n">water_density</span><span class="p">)</span> <span class="o">*</span> <span class="mf">9.80665</span> <span class="o">*</span> <span class="n">depth</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">P_eff_gpa</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Effective pressure is zero. Hertz-Mindlin moduli will be zero.&quot;</span><span class="p">)</span>

    <span class="c1"># Hertz-Mindlin moduli for dry frame at critical porosity (phi_c)</span>
    <span class="c1"># K_HM_dry = [ C^2 * (1-φ_c)^2 * G_m^2 * P_eff / (18 * π^2 * (1-v_m)^2) ]^(1/3)</span>
    <span class="c1"># G_HM_dry = Factor * [ (3*C^2*(1-φ_c)^2*G_m^2*P_eff) / (2*π^2*(1-v_m)^2) ]^(1/3)</span>
    <span class="n">den_hm</span> <span class="o">=</span> <span class="p">(</span><span class="mi">18</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">v_matrix</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den_hm</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Matrix Poisson&#39;s ratio </span><span class="si">{</span><span class="n">v_matrix</span><span class="si">}</span><span class="s2"> causes division by zero in HM calc.&quot;</span><span class="p">)</span>
    
    <span class="n">K_HM_dry_crit</span> <span class="o">=</span> <span class="p">(</span><span class="n">coordination_number</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">critical_porosity</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">G_matrix</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">P_eff_gpa</span> <span class="o">/</span> <span class="n">den_hm</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="n">P_eff_gpa</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
    
    <span class="n">g_hm_factor_num</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">v_matrix</span><span class="p">)</span>
    <span class="n">g_hm_factor_den</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v_matrix</span><span class="p">)</span> <span class="c1"># Original was (10-2v), same as 2*(5-v). For consistency with class: 5*(2-v)</span>
                                          <span class="c1"># Using 5*(2-v) instead of 2*(5-v) based on common forms.</span>
                                          <span class="c1"># If original (10-2v) is intended: (5-4v)/(2*(5-v))</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">g_hm_factor_den</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Matrix Poisson&#39;s ratio </span><span class="si">{</span><span class="n">v_matrix</span><span class="si">}</span><span class="s2"> causes division by zero in G_HM factor.&quot;</span><span class="p">)</span>
    <span class="n">g_hm_factor</span> <span class="o">=</span> <span class="n">g_hm_factor_num</span> <span class="o">/</span> <span class="n">g_hm_factor_den</span>
    
    <span class="n">g_hm_bracket_term_cubed_den</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">v_matrix</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">g_hm_bracket_term_cubed_den</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Matrix Poisson&#39;s ratio </span><span class="si">{</span><span class="n">v_matrix</span><span class="si">}</span><span class="s2"> causes division by zero in G_HM bracket term.&quot;</span><span class="p">)</span>
    <span class="n">g_hm_bracket_term_cubed</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">coordination_number</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">critical_porosity</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">G_matrix</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">P_eff_gpa</span><span class="p">)</span> <span class="o">/</span> \
                              <span class="n">g_hm_bracket_term_cubed_den</span>
    <span class="n">G_HM_dry_crit</span> <span class="o">=</span> <span class="n">g_hm_factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">g_hm_bracket_term_cubed</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="k">if</span> <span class="n">P_eff_gpa</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
    
    <span class="n">Vp_high_list</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Using lists for append, then convert to array</span>
    <span class="n">Vp_low_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phi_array</span><span class="p">)):</span>
        <span class="n">current_phi</span> <span class="o">=</span> <span class="n">phi_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">current_sat</span> <span class="o">=</span> <span class="n">saturation_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">current_phi</span> <span class="o">&lt;=</span> <span class="mf">1.0</span> <span class="ow">and</span> <span class="mf">0.0</span> <span class="o">&lt;=</span> <span class="n">current_sat</span> <span class="o">&lt;=</span> <span class="mf">1.0</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Invalid phi (</span><span class="si">{</span><span class="n">current_phi</span><span class="si">}</span><span class="s2">) or sat (</span><span class="si">{</span><span class="n">current_sat</span><span class="si">}</span><span class="s2">) at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">. Resulting Vp will be NaN.&quot;</span><span class="p">)</span>
            <span class="n">Vp_high_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">Vp_low_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">K_eff_dry_H_i</span><span class="p">,</span> <span class="n">G_eff_dry_H_i</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>
        <span class="n">K_eff_dry_L_i</span><span class="p">,</span> <span class="n">G_eff_dry_L_i</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="n">current_phi</span> <span class="o">&lt;</span> <span class="n">critical_porosity</span><span class="p">:</span>
            <span class="c1"># Modified Hashin-Shtrikman bounds for porosity &lt; critical_porosity</span>
            <span class="c1"># Lower bound moduli (effective medium with K_HM, G_HM as &quot;soft&quot; component)</span>
            <span class="n">den1_Kl</span> <span class="o">=</span> <span class="n">K_HM_dry_crit</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">G_HM_dry_crit</span>
            <span class="n">den2_Kl</span> <span class="o">=</span> <span class="n">K_matrix</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">G_HM_dry_crit</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den1_Kl</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den2_Kl</span><span class="p">,</span><span class="mi">0</span><span class="p">)):</span>
                 <span class="n">K_eff_dry_L_i</span> <span class="o">=</span> <span class="p">((</span><span class="n">current_phi</span> <span class="o">/</span> <span class="n">critical_porosity</span><span class="p">)</span> <span class="o">/</span> <span class="n">den1_Kl</span> <span class="o">+</span> \
                               <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">current_phi</span> <span class="o">/</span> <span class="n">critical_porosity</span><span class="p">)</span> <span class="o">/</span> <span class="n">den2_Kl</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">G_HM_dry_crit</span>
            
            <span class="n">zeta_L_den</span> <span class="o">=</span> <span class="p">(</span><span class="n">K_HM_dry_crit</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">G_HM_dry_crit</span><span class="p">)</span>
            <span class="n">zeta_L</span> <span class="o">=</span> <span class="p">(</span><span class="n">G_HM_dry_crit</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="n">K_HM_dry_crit</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">G_HM_dry_crit</span><span class="p">)</span> <span class="o">/</span> \
                     <span class="n">zeta_L_den</span> <span class="k">if</span> <span class="n">zeta_L_den</span> <span class="o">!=</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">den1_Gl</span> <span class="o">=</span> <span class="n">G_HM_dry_crit</span> <span class="o">+</span> <span class="n">zeta_L</span>
            <span class="n">den2_Gl</span> <span class="o">=</span> <span class="n">G_matrix</span> <span class="o">+</span> <span class="n">zeta_L</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den1_Gl</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den2_Gl</span><span class="p">,</span><span class="mi">0</span><span class="p">)):</span>
                <span class="n">G_eff_dry_L_i</span> <span class="o">=</span> <span class="p">((</span><span class="n">current_phi</span> <span class="o">/</span> <span class="n">critical_porosity</span><span class="p">)</span> <span class="o">/</span> <span class="n">den1_Gl</span> <span class="o">+</span> \
                               <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">current_phi</span> <span class="o">/</span> <span class="n">critical_porosity</span><span class="p">)</span> <span class="o">/</span> <span class="n">den2_Gl</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">zeta_L</span>

            <span class="c1"># Upper bound moduli (effective medium with K_matrix, G_matrix as &quot;stiff&quot; component, K_HM as &quot;soft&quot;)</span>
            <span class="n">den1_Kh</span> <span class="o">=</span> <span class="n">K_HM_dry_crit</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">G_matrix</span> <span class="c1"># Uses G_matrix here</span>
            <span class="n">den2_Kh</span> <span class="o">=</span> <span class="n">K_matrix</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">G_matrix</span>      <span class="c1"># Uses G_matrix here</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den1_Kh</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den2_Kh</span><span class="p">,</span><span class="mi">0</span><span class="p">)):</span>
                <span class="n">K_eff_dry_H_i</span> <span class="o">=</span> <span class="p">((</span><span class="n">current_phi</span> <span class="o">/</span> <span class="n">critical_porosity</span><span class="p">)</span> <span class="o">/</span> <span class="n">den1_Kh</span> <span class="o">+</span> \
                               <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">current_phi</span> <span class="o">/</span> <span class="n">critical_porosity</span><span class="p">)</span> <span class="o">/</span> <span class="n">den2_Kh</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">G_matrix</span>

            <span class="n">zeta_H_den</span> <span class="o">=</span> <span class="p">(</span><span class="n">K_matrix</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">G_matrix</span><span class="p">)</span>
            <span class="n">zeta_H</span> <span class="o">=</span> <span class="p">(</span><span class="n">G_matrix</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="n">K_matrix</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">G_matrix</span><span class="p">)</span> <span class="o">/</span> \
                     <span class="n">zeta_H_den</span> <span class="k">if</span> <span class="n">zeta_H_den</span><span class="o">!=</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">den1_Gh</span> <span class="o">=</span> <span class="n">G_HM_dry_crit</span> <span class="o">+</span> <span class="n">zeta_H</span> <span class="c1"># Uses G_HM_dry_crit here</span>
            <span class="n">den2_Gh</span> <span class="o">=</span> <span class="n">G_matrix</span> <span class="o">+</span> <span class="n">zeta_H</span>      <span class="c1"># Uses G_matrix here</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den1_Gh</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den2_Gh</span><span class="p">,</span><span class="mi">0</span><span class="p">)):</span>
                <span class="n">G_eff_dry_H_i</span> <span class="o">=</span> <span class="p">((</span><span class="n">current_phi</span> <span class="o">/</span> <span class="n">critical_porosity</span><span class="p">)</span> <span class="o">/</span> <span class="n">den1_Gh</span> <span class="o">+</span> \
                               <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">current_phi</span> <span class="o">/</span> <span class="n">critical_porosity</span><span class="p">)</span> <span class="o">/</span> <span class="n">den2_Gh</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">zeta_H</span>
            
            <span class="n">K_eff_dry_L_i</span><span class="p">,</span> <span class="n">G_eff_dry_L_i</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">K_eff_dry_L_i</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">G_eff_dry_L_i</span><span class="p">)</span>
            <span class="n">K_eff_dry_H_i</span><span class="p">,</span> <span class="n">G_eff_dry_H_i</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">K_eff_dry_H_i</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">G_eff_dry_H_i</span><span class="p">)</span>

            <span class="c1"># Fluid substitution using satK helper (which uses Brie for K_fluid_eff)</span>
            <span class="n">K_sat_H</span> <span class="o">=</span> <span class="n">satK</span><span class="p">(</span><span class="n">K_eff_dry_H_i</span><span class="p">,</span> <span class="n">K_matrix</span><span class="p">,</span> <span class="n">current_phi</span><span class="p">,</span> <span class="n">current_sat</span><span class="p">,</span> <span class="n">water_bulk_modulus</span><span class="p">,</span> <span class="n">gas_bulk_modulus</span><span class="p">)</span>
            <span class="n">G_sat_H</span> <span class="o">=</span> <span class="n">G_eff_dry_H_i</span> <span class="c1"># Shear modulus unchanged by fluid (Gassmann)</span>
            <span class="n">K_sat_L</span> <span class="o">=</span> <span class="n">satK</span><span class="p">(</span><span class="n">K_eff_dry_L_i</span><span class="p">,</span> <span class="n">K_matrix</span><span class="p">,</span> <span class="n">current_phi</span><span class="p">,</span> <span class="n">current_sat</span><span class="p">,</span> <span class="n">water_bulk_modulus</span><span class="p">,</span> <span class="n">gas_bulk_modulus</span><span class="p">)</span>
            <span class="n">G_sat_L</span> <span class="o">=</span> <span class="n">G_eff_dry_L_i</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># Porosity &gt;= critical_porosity: Suspension model (Reuss-like average)</span>
            <span class="c1"># This models the rock as a suspension of &quot;critical porosity grains&quot; in additional fluid.</span>
            <span class="c1"># The &quot;solid&quot; part is the frame at critical_porosity (K_HM_dry_crit, G_HM_dry_crit).</span>
            <span class="c1"># The &quot;excess porosity&quot; (current_phi - critical_porosity) is filled with fluid.</span>
            <span class="c1"># The original code for K_eff_susp_dry:</span>
            <span class="c1"># K_eff = ((1-phi)/(1-phi_c)/(K_HM + 4/3 G_HM) + (phi-phi_c)/(1-phi_c)/(4/3 G_HM))^-1 - 4/3 G_HM</span>
            <span class="c1"># This form is complex and its derivation/assumptions for the &quot;fluid part K=0&quot; term (4/3 G_HM) need verification.</span>
            <span class="c1"># For a simple Reuss average of frame_at_phi_c and fluid_in_excess_pores (K_fluid_eff, G_fluid_eff=0):</span>
            <span class="c1"># phi_excess_vol_fraction = (current_phi - critical_porosity) / (1 - critical_porosity) -&gt; This is fraction of non-solid volume</span>
            <span class="c1"># K_dry_susp = ((1-phi_excess_vol_fraction)/K_HM_dry_crit + phi_excess_vol_fraction/K_pore_dry)^-1</span>
            <span class="c1"># G_dry_susp = ((1-phi_excess_vol_fraction)/G_HM_dry_crit + phi_excess_vol_fraction/G_pore_dry)^-1</span>
            <span class="c1"># Assuming K_pore_dry = 0, G_pore_dry = 0 for empty excess pores.</span>
            <span class="c1"># The original code seems to use a specific variant. We will follow it.</span>

            <span class="c1"># Fraction of original solid phase (at critical porosity) in the (1-phi_c) volume</span>
            <span class="n">frac_solid_phase</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">current_phi</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">critical_porosity</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">critical_porosity</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="c1"># Fraction of &quot;added&quot; pore space (beyond critical) in the (1-phi_c) volume</span>
            <span class="n">frac_added_pores</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_phi</span> <span class="o">-</span> <span class="n">critical_porosity</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">critical_porosity</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">critical_porosity</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1.0</span>
            
            <span class="c1"># Ensure fractions are valid (e.g. phi_i should not be &lt; critical_porosity here if logic is strict)</span>
            <span class="c1"># However, original code structure implies phi_i &gt;= critical_porosity for this branch.</span>
            <span class="c1"># If phi_i = critical_porosity, then frac_solid_phase=1, frac_added_pores=0. K_eff should be K_HM.</span>

            <span class="c1"># Denominators for K_eff_susp_dry terms</span>
            <span class="n">den1_Keff_susp</span> <span class="o">=</span> <span class="n">K_HM_dry_crit</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">G_HM_dry_crit</span>
            <span class="n">den2_Keff_susp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">G_HM_dry_crit</span> <span class="c1"># This term for K is unusual (fluid K=0 usually)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den1_Keff_susp</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den2_Keff_susp</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">critical_porosity</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)):</span>
                 <span class="n">K_eff_dry_susp</span> <span class="o">=</span> <span class="p">(</span> <span class="n">frac_solid_phase</span> <span class="o">/</span> <span class="n">den1_Keff_susp</span> <span class="o">+</span> <span class="n">frac_added_pores</span> <span class="o">/</span> <span class="n">den2_Keff_susp</span> 
                                   <span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">G_HM_dry_crit</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">K_eff_dry_susp</span> <span class="o">=</span> <span class="mf">0.0</span> 
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">current_phi</span><span class="p">,</span> <span class="n">critical_porosity</span><span class="p">):</span> <span class="n">K_eff_dry_susp</span> <span class="o">=</span> <span class="n">K_HM_dry_crit</span>
            
            <span class="n">zeta_susp_den</span> <span class="o">=</span> <span class="p">(</span><span class="n">K_HM_dry_crit</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">G_HM_dry_crit</span><span class="p">)</span>
            <span class="n">zeta_susp</span> <span class="o">=</span> <span class="p">(</span><span class="n">G_HM_dry_crit</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="n">K_HM_dry_crit</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">G_HM_dry_crit</span><span class="p">)</span> <span class="o">/</span> \
                        <span class="n">zeta_susp_den</span> <span class="k">if</span> <span class="n">zeta_susp_den</span> <span class="o">!=</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">den1_Geff_susp</span> <span class="o">=</span> <span class="n">G_HM_dry_crit</span> <span class="o">+</span> <span class="n">zeta_susp</span>
            <span class="n">den2_Geff_susp</span> <span class="o">=</span> <span class="n">zeta_susp</span> <span class="c1"># Term for &quot;added pores&quot; G=0 contribution</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den1_Geff_susp</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">den2_Geff_susp</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">critical_porosity</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)):</span>
                <span class="n">G_eff_dry_susp</span> <span class="o">=</span> <span class="p">(</span> <span class="n">frac_solid_phase</span> <span class="o">/</span> <span class="n">den1_Geff_susp</span> <span class="o">+</span> <span class="n">frac_added_pores</span> <span class="o">/</span> <span class="n">den2_Geff_susp</span>
                                   <span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">zeta_susp</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">G_eff_dry_susp</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">current_phi</span><span class="p">,</span> <span class="n">critical_porosity</span><span class="p">):</span> <span class="n">G_eff_dry_susp</span> <span class="o">=</span> <span class="n">G_HM_dry_crit</span>
            
            <span class="n">K_eff_dry_susp</span><span class="p">,</span> <span class="n">G_eff_dry_susp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">K_eff_dry_susp</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">G_eff_dry_susp</span><span class="p">)</span>

            <span class="n">K_sat_H</span> <span class="o">=</span> <span class="n">K_sat_L</span> <span class="o">=</span> <span class="n">satK</span><span class="p">(</span><span class="n">K_eff_dry_susp</span><span class="p">,</span> <span class="n">K_matrix</span><span class="p">,</span> <span class="n">current_phi</span><span class="p">,</span> <span class="n">current_sat</span><span class="p">,</span> <span class="n">water_bulk_modulus</span><span class="p">,</span> <span class="n">gas_bulk_modulus</span><span class="p">)</span>
            <span class="n">G_sat_H</span> <span class="o">=</span> <span class="n">G_sat_L</span> <span class="o">=</span> <span class="n">G_eff_dry_susp</span>

        <span class="c1"># Total effective density</span>
        <span class="n">rho_fluid_eff</span> <span class="o">=</span> <span class="n">current_sat</span> <span class="o">*</span> <span class="n">water_density</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">current_sat</span><span class="p">)</span> <span class="o">*</span> <span class="n">gas_density</span>
        <span class="n">rho_total_eff</span> <span class="o">=</span> <span class="n">rho_matrix</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">current_phi</span><span class="p">)</span> <span class="o">+</span> <span class="n">rho_fluid_eff</span> <span class="o">*</span> <span class="n">current_phi</span>
        <span class="k">if</span> <span class="n">rho_total_eff</span> <span class="o">&lt;=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">Vp_high_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">);</span> <span class="n">Vp_low_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># P-wave velocities (GPa for K,G converted to Pa by 1e9)</span>
        <span class="n">p_mod_H</span> <span class="o">=</span> <span class="n">K_sat_H</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">G_sat_H</span> <span class="o">*</span> <span class="mf">1e9</span>
        <span class="n">p_mod_L</span> <span class="o">=</span> <span class="n">K_sat_L</span> <span class="o">*</span> <span class="mf">1e9</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">G_sat_L</span> <span class="o">*</span> <span class="mf">1e9</span>

        <span class="n">Vp_high_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_mod_H</span> <span class="o">/</span> <span class="n">rho_total_eff</span><span class="p">)</span> <span class="k">if</span> <span class="n">p_mod_H</span> <span class="o">&gt;=</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">Vp_low_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_mod_L</span> <span class="o">/</span> <span class="n">rho_total_eff</span><span class="p">)</span> <span class="k">if</span> <span class="n">p_mod_L</span> <span class="o">&gt;=</span><span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Vp_high_list</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Vp_low_list</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Hang Chen.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>